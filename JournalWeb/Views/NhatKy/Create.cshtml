@{
    ViewData["Title"] = "Viết nhật ký";
}

<style>
    body {
        background: #f4f6fa;
    }

    .editor {
        max-width: 680px;
        margin: auto;
        padding: 15px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

        .header a {
            font-size: 22px;
            text-decoration: none;
        }

    .mood-box {
        border-radius: 24px;
        padding: 20px 18px 16px;
        margin-bottom: 14px;
        background: radial-gradient(circle at 50% 24%, #e5def5, #c7bbe8);
        box-shadow: inset 0 0 48px rgba(255,255,255,.42);
        transition: .35s ease;
    }

    .section-title {
        font-weight: 700;
        margin: 12px 0 8px;
        color: #2f334f;
    }

    .mood-name {
        text-align: center;
        font-weight: 800;
        font-size: 46px;
        margin: 10px 0 8px;
        color: #20213a;
        letter-spacing: -.4px;
    }

    .mood-art-wrap {
        display: flex;
        justify-content: center;
        margin-top: 8px;
    }

    .mood-art {
        width: 230px;
        height: 230px;
        position: relative;
        filter: drop-shadow(0 16px 24px rgba(0,0,0,.12));
        animation: floatMood 4s ease-in-out infinite;
    }

    .mood-svg,
    .mood-svg-mini {
        width: 100%;
        height: 100%;
        display: block;
    }

        .mood-svg .layer1,
        .mood-svg .layer2,
        .mood-svg .layer3,
        .mood-svg .core,
        .mood-svg-mini .layer1,
        .mood-svg-mini .layer2,
        .mood-svg-mini .layer3,
        .mood-svg-mini .core {
            transform-origin: 50% 50%;
        }

        .mood-svg .layer1,
        .mood-svg-mini .layer1 {
            animation: rippleOuter 4.2s ease-in-out infinite;
        }

        .mood-svg .layer2,
        .mood-svg-mini .layer2 {
            animation: rippleMid 3.5s ease-in-out infinite;
        }

        .mood-svg .layer3,
        .mood-svg-mini .layer3 {
            animation: rippleInner 2.9s ease-in-out infinite;
        }

        .mood-svg .core,
        .mood-svg-mini .core {
            animation: coreBlink 2.2s ease-in-out infinite;
        }

    @@keyframes floatMood {
        0%, 100% {
            transform: translateY(0) scale(1);
        }

        50% {
            transform: translateY(-3px) scale(1.015);
        }
    }

    @@keyframes rippleOuter {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.03) rotate(-2deg);
        }
    }

    @@keyframes rippleMid {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.05) rotate(2deg);
        }
    }

    @@keyframes rippleInner {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.07) rotate(-3deg);
        }
    }

    @@keyframes coreBlink {
        0%, 100% {
            opacity: .82;
            filter: brightness(1);
        }

        50% {
            opacity: 1;
            filter: brightness(1.2);
        }
    }

    .mood-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 20px;
        border-radius: 99px;
        background: rgba(255,255,255,.46);
        outline: none;
    }

        .mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.88);
            box-shadow: 0 6px 14px rgba(0,0,0,.14);
            cursor: pointer;
        }

        .mood-slider::-moz-range-thumb {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.88);
            box-shadow: 0 6px 14px rgba(0,0,0,.14);
            cursor: pointer;
        }

    .mood-label-row {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 12px;
        color: #555a74;
        font-weight: 700;
    }

    .chip-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .chip {
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 13px;
        background: rgba(255,255,255,.68);
        color: #2f334f;
    }

        .chip.active {
            background: #2f334f;
            color: #fff;
        }

    textarea {
        border-radius: 12px;
    }

    .upload-tip {
        font-size: 13px;
        color: #6c757d;
        margin-top: 4px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .media-item {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: #eef2f7;
        min-height: 100px;
    }

        .media-item.big {
            grid-row: span 2;
            min-height: 210px;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .media-type {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background: rgba(0,0,0,.55);
        color: #fff;
        font-size: 12px;
        padding: 2px 7px;
        border-radius: 20px;
    }

    .emotion-cover {
        background: radial-gradient(circle at center, rgba(255,255,255,.95), rgba(255,255,255,.35));
    }

    .emotion-caption {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 8px;
        text-align: center;
        font-weight: 700;
        color: #2a2d47;
        background: rgba(255,255,255,.72);
        border-radius: 12px;
        font-size: 12px;
        padding: 3px 6px;
    }

    .mini-art {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .mini-art .mood-svg-mini {
            width: 120px;
            height: 120px;
        }
</style>

<div class="editor">
    <div class="header">
        <a href="@Url.Action("Index")">⬅</a>
        <h5 class="mb-0">Nhật ký mới</h5>
    </div>

    <div class="mood-box" id="moodBox">
        <div class="section-title text-center">Chọn cảm giác của bạn ngay lúc này</div>

        <div class="mood-art-wrap">
            <div class="mood-art" id="moodArt"></div>
        </div>

        <div class="mood-name" id="moodName">Rất khó chịu</div>

        <input id="moodRange" class="mood-slider" type="range" min="0" max="6" value="0" />
        <div class="mood-label-row"><span>RẤT KHÓ CHỊU</span><span>RẤT DỄ CHỊU</span></div>

        <div class="section-title">Điều nào mô tả đúng nhất về cảm giác này?</div>
        <div class="chip-wrap" id="moodDescWrap"></div>

        <div class="section-title">Điều gì đang có tác động lớn nhất đối với bạn?</div>
        <div class="chip-wrap" id="moodImpactWrap"></div>
    </div>

    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="moodLevel" id="moodLevel" value="0" />
        <input type="hidden" name="moodLabel" id="moodLabel" value="Rất khó chịu" />

        <input class="form-control my-2" name="tieuDe" placeholder="Tiêu đề (không bắt buộc)" />
        <input type="date" name="ngayViet" class="form-control my-2" value="@DateTime.Now.ToString("yyyy-MM-dd")" />

        <textarea class="form-control my-2" rows="6" name="noiDung" placeholder="Hôm nay bạn cảm thấy thế nào?"></textarea>

        <input type="file" name="medias" class="form-control my-2" accept="image/*,video/*" multiple onchange="handleMediaSelection(this)" />

        <div class="upload-tip">Bạn có thể chọn nhiều ảnh + video ngắn cùng lúc.</div>
        <div class="media-grid" id="preview"></div>

        @if (ViewBag.Loi != null)
        {
            <div class="text-danger mt-2">@ViewBag.Loi</div>
        }

        <button class="btn btn-primary w-100 mt-3">💾 Lưu nhật ký</button>
    </form>
</div>

<script>
    const moodStates = [
        { name: "Rất khó chịu", bg: "radial-gradient(circle at 50% 25%, #d9d2ef, #bcb0e3)", c1: "#f4ebff", c2: "#c39aff", c3: "#7c4bc4", waves: 8, amp: .24, desc: ["Tức giận", "Lo lắng", "Sợ hãi", "Ngợp", "Xấu hổ", "Chán ghét", "Bối rối", "Nản lòng", "Khó chịu", "Ghen tị", "Căng thẳng", "Lo âu", "Tội lỗi", "Ngạc nhiên", "Vô vọng", "Bực tức", "Cô đơn", "Chán nản", "Thất vọng", "Kiệt sức", "Buồn"] },
        { name: "Khó chịu", bg: "radial-gradient(circle at 50% 25%, #d7e2fb, #beccef)", c1: "#eef4ff", c2: "#9fb8ff", c3: "#5278e5", waves: 7, amp: .20, desc: ["Bực bội", "Căng thẳng", "Mệt mỏi", "Khó chịu", "Lúng túng", "Buồn chán", "Thiếu động lực", "Áp lực"] },
        { name: "Hơi khó chịu", bg: "radial-gradient(circle at 50% 25%, #dff0f8, #cbdeee)", c1: "#ecf8ff", c2: "#92cdf5", c3: "#4a9fdb", waves: 6, amp: .17, desc: ["Hơi mệt", "Lăn tăn", "Không tập trung", "Thiếu năng lượng", "Lo nhẹ", "Không thoải mái"] },
        { name: "Bình thường", bg: "radial-gradient(circle at 50% 25%, #e0eef2, #c9dde2)", c1: "#f6fdff", c2: "#a8dcee", c3: "#77b8cf", rings: true, desc: ["Hài lòng", "Bình tĩnh", "Bình yên", "Lãnh đạm", "Kiệt sức"] },
        { name: "Hơi dễ chịu", bg: "radial-gradient(circle at 50% 25%, #e4f5d8, #cce6ba)", c1: "#f2ffe7", c2: "#a5e86f", c3: "#6bc436", waves: 5, amp: .13, desc: ["Nhẹ nhõm", "Thoải mái", "Dễ chịu", "Khá vui", "Ổn định", "Có hy vọng"] },
        { name: "Dễ chịu", bg: "radial-gradient(circle at 50% 25%, #f9efc8, #eedca5)", c1: "#fff8df", c2: "#ffde58", c3: "#f0b21f", waves: 5, amp: .18, star: true, desc: ["Vui", "Lạc quan", "Hài lòng", "Tự tin", "Yêu đời", "Tích cực", "Thoả mãn"] },
        { name: "Rất dễ chịu", bg: "radial-gradient(circle at 50% 25%, #f8e4ba, #f0cf96)", c1: "#fff7e3", c2: "#ffc75f", c3: "#f09d17", waves: 5, amp: .24, star: true, desc: ["Kinh ngạc", "Phấn khích", "Ngạc nhiên", "Sôi nổi", "Hạnh phúc", "Vui vẻ", "Dũng cảm", "Tự hào", "Tự tin", "Hy vọng", "Thích thú", "Thoả mãn", "Nhẹ nhõm", "Biết ơn", "Hài lòng", "Bình tĩnh", "Bình yên"] }
    ];

    const impacts = ["Sức khỏe", "Thể dục", "Chăm sóc bản thân", "Sở thích", "Danh tính", "Tâm linh", "Cộng đồng", "Gia đình", "Bạn bè", "Bạn đời", "Hẹn hò", "Nhiệm vụ", "Công việc", "Giáo dục", "Du lịch", "Thời tiết", "Sự kiện hiện tại", "Tiền"];

    const selectedFiles = [];
    const selectedDescs = new Set();
    const selectedImpacts = new Set();

    function blobPoints(radius, waves, amp, count = 220) {
        let pts = [];
        for (let i = 0; i < count; i++) {
            const t = (Math.PI * 2 * i) / count;
            const r = radius * (1 + amp * Math.sin(waves * t));
            const x = 50 + r * Math.cos(t);
            const y = 50 + r * Math.sin(t);
            pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
        }
        return pts.join(' ');
    }

    function buildMoodSvg(mood, mini = false) {
        const cls = mini ? 'mood-svg-mini' : 'mood-svg';

        if (mood.rings) {
            return `
            <svg class="${cls}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle class="layer1" cx="50" cy="50" r="42" fill="none" stroke="${mood.c1}" stroke-width="1.2"/>
                <circle class="layer2" cx="50" cy="50" r="31" fill="none" stroke="${mood.c2}" stroke-width="1.6"/>
                <circle class="layer3" cx="50" cy="50" r="20" fill="url(#g1)" stroke="${mood.c3}" stroke-width="1.2"/>
                <circle class="core" cx="50" cy="50" r="4.5" fill="#fff"/>
                <defs>
                    <radialGradient id="g1" cx="35%" cy="30%">
                        <stop offset="0%" stop-color="#ffffff"/>
                        <stop offset="100%" stop-color="${mood.c2}"/>
                    </radialGradient>
                </defs>
            </svg>`;
        }

        const w = mood.waves || 6;
        const amp1 = mood.amp || .2;
        const amp2 = Math.max(.08, amp1 - .05);
        const amp3 = Math.max(.05, amp2 - .03);
        const p1 = blobPoints(38, w, amp1);
        const p2 = blobPoints(29, w, amp2);
        const p3 = blobPoints(20, w, amp3);

        return `
        <svg class="${cls}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="ga" cx="30%" cy="28%">
                    <stop offset="0%" stop-color="#ffffff"/>
                    <stop offset="100%" stop-color="${mood.c1}"/>
                </radialGradient>
                <radialGradient id="gb" cx="35%" cy="32%">
                    <stop offset="0%" stop-color="#ffffff"/>
                    <stop offset="100%" stop-color="${mood.c2}"/>
                </radialGradient>
                <radialGradient id="gc" cx="40%" cy="34%">
                    <stop offset="0%" stop-color="#ffffff"/>
                    <stop offset="100%" stop-color="${mood.c3}"/>
                </radialGradient>
            </defs>
            <polygon class="layer1" points="${p1}" fill="url(#ga)" stroke="${mood.c3}" stroke-opacity=".42" stroke-width=".8"/>
            <polygon class="layer2" points="${p2}" fill="url(#gb)" stroke="${mood.c3}" stroke-opacity=".56" stroke-width=".9"/>
            <polygon class="layer3" points="${p3}" fill="url(#gc)" stroke="${mood.c3}" stroke-opacity=".76" stroke-width="1"/>
            <circle class="core" cx="50" cy="50" r="2.8" fill="#fff"/>
        </svg>`;
    }

    function renderChips(containerId, items, targetSet) {
        const wrap = document.getElementById(containerId);
        wrap.innerHTML = "";
        items.forEach(text => {
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "chip";
            chip.innerText = text;
            chip.onclick = () => {
                if (targetSet.has(text)) {
                    targetSet.delete(text);
                    chip.classList.remove("active");
                } else {
                    targetSet.add(text);
                    chip.classList.add("active");
                }
            };
            wrap.appendChild(chip);
        });
    }

    function updateMoodUI(level) {
        const mood = moodStates[level];
        document.getElementById("moodName").innerText = mood.name;
        document.getElementById("moodBox").style.background = mood.bg;
        document.getElementById("moodLabel").value = mood.name;
        document.getElementById("moodLevel").value = level;
        document.getElementById("moodArt").innerHTML = buildMoodSvg(mood);

        selectedDescs.clear();
        renderChips("moodDescWrap", mood.desc, selectedDescs);
        renderChips("moodImpactWrap", impacts, selectedImpacts);
    }

    function handleMediaSelection(input) {
        if (!input || !input.files || !input.files.length) return;
        for (const file of input.files) {
            const isExists = selectedFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified);
            if (!isExists) selectedFiles.push(file);
        }
        syncInputFiles(input);
        renderPreview();
    }

    function syncInputFiles(input) {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        input.files = dt.files;
    }

    function removeMedia(index) {
        selectedFiles.splice(index, 1);
        const input = document.querySelector('input[name="medias"]');
        if (input) syncInputFiles(input);
        renderPreview();
    }

    function moodMiniHtml(mood) {
        return `<div class="mini-art">${buildMoodSvg(mood, true)}</div>`;
    }

    function renderPreview() {
        const p = document.getElementById("preview");
        p.innerHTML = "";

        const moodLevel = Number(document.getElementById("moodLevel").value || 0);
        const mood = moodStates[moodLevel];

        const emotionItem = document.createElement("div");
        emotionItem.className = "media-item big emotion-cover";
        emotionItem.style.background = mood.bg;
        emotionItem.innerHTML = moodMiniHtml(mood) + `<div class="emotion-caption">${mood.name}</div>`;
        p.appendChild(emotionItem);

        selectedFiles.forEach((file, idx) => {
            const item = document.createElement("div");
            item.className = "media-item";

            if (file.type.startsWith("image")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                item.appendChild(img);
            } else if (file.type.startsWith("video")) {
                const v = document.createElement("video");
                v.src = URL.createObjectURL(file);
                v.muted = true;
                v.playsInline = true;
                v.controls = true;
                item.appendChild(v);
            }

            const badge = document.createElement("div");
            badge.className = "media-type";
            badge.innerText = file.type.startsWith("video") ? "Video" : "Ảnh";
            item.appendChild(badge);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-sm btn-light";
            removeBtn.style.position = "absolute";
            removeBtn.style.left = "8px";
            removeBtn.style.top = "8px";
            removeBtn.style.borderRadius = "20px";
            removeBtn.innerText = "✕";
            removeBtn.onclick = () => removeMedia(idx);
            item.appendChild(removeBtn);

            p.appendChild(item);
        });
    }

    document.getElementById("moodRange").addEventListener("input", (e) => {
        updateMoodUI(Number(e.target.value));
        renderPreview();
    });

    updateMoodUI(0);
    renderPreview();
</script>
