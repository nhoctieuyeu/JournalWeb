@{
    ViewData["Title"] = "Viết nhật ký";
}

<style>
    body {
        background: #f4f6fa;
    }

    .editor {
        max-width: 680px;
        margin: auto;
        padding: 15px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

        .header a {
            font-size: 22px;
            text-decoration: none;
        }

    .mood-box {
        border-radius: 24px;
        padding: 20px 18px 16px;
        margin-bottom: 14px;
        background: radial-gradient(circle at 50% 25%, #e7e0f4, #cbc0e7);
        box-shadow: inset 0 0 45px rgba(255,255,255,.4);
        transition: .35s ease;
    }

    .section-title {
        font-weight: 700;
        margin: 12px 0 8px;
        color: #2f334f;
    }

    .mood-name {
        text-align: center;
        font-weight: 800;
        font-size: 46px;
        margin: 10px 0 8px;
        color: #20213a;
        letter-spacing: -.5px;
    }

    .mood-art-wrap {
        display: flex;
        justify-content: center;
        margin-top: 8px;
    }

    .mood-art {
        --c1: #f4e8ff;
        --c2: #caa5ff;
        --c3: #8f67d8;
        --c4: #ffffff;
        width: 210px;
        height: 210px;
        position: relative;
        filter: drop-shadow(0 20px 26px color-mix(in srgb, var(--c3) 35%, transparent));
        animation: breath 3.2s ease-in-out infinite;
        transform-style: preserve-3d;
    }

        .mood-art .layer,
        .mood-art .core {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 30%, var(--c1), var(--c2));
            border: 2px solid color-mix(in srgb, var(--c4) 82%, var(--c3));
        }

        .mood-art .l1 {
            transform: scale(1) rotate(2deg);
            opacity: .97;
            animation: rippleA 4.2s ease-in-out infinite;
        }

        .mood-art .l2 {
            transform: scale(.78) rotate(-7deg);
            opacity: .96;
            animation: rippleB 3.3s ease-in-out infinite;
        }

        .mood-art .l3 {
            transform: scale(.58) rotate(11deg);
            opacity: .98;
            animation: rippleC 2.7s ease-in-out infinite;
        }

        .mood-art .core {
            inset: 44%;
            background: radial-gradient(circle at center, #fff, color-mix(in srgb, var(--c2) 78%, white));
            border: 0;
            box-shadow: 0 0 18px color-mix(in srgb, var(--c3) 52%, transparent);
            animation: coreGlow 2.2s ease-in-out infinite;
        }

    .shape-spiky .layer,
    .shape-spiky .core {
        clip-path: polygon(50% 0%, 62% 18%, 83% 10%, 78% 33%, 100% 50%, 78% 67%, 83% 90%, 62% 82%, 50% 100%, 38% 82%, 17% 90%, 22% 67%, 0% 50%, 22% 33%, 17% 10%, 38% 18%);
        border-radius: 0;
    }

    .shape-wave .layer,
    .shape-wave .core {
        border-radius: 44% 56% 47% 53% / 52% 45% 55% 48%;
    }

    .shape-soft .layer,
    .shape-soft .core {
        border-radius: 50% 50% 46% 54% / 42% 58% 42% 58%;
    }

    .shape-pentagon .layer,
    .shape-pentagon .core {
        clip-path: polygon(50% 2%, 95% 35%, 79% 92%, 21% 92%, 5% 35%);
        border-radius: 0;
    }

    .shape-star .layer,
    .shape-star .core {
        clip-path: polygon(50% 0%, 61% 30%, 95% 35%, 69% 56%, 78% 90%, 50% 70%, 22% 90%, 31% 56%, 5% 35%, 39% 30%);
        border-radius: 0;
    }

    .shape-rings .layer,
    .shape-rings .core {
        clip-path: none;
        border-radius: 50%;
    }

    .shape-rings .l1 {
        background: transparent;
        border: 2px solid color-mix(in srgb, var(--c4) 85%, var(--c2));
    }

    .shape-rings .l2 {
        inset: 13%;
        background: transparent;
        border: 2px solid color-mix(in srgb, var(--c4) 40%, var(--c2));
    }

    .shape-rings .l3 {
        inset: 28%;
        background: radial-gradient(circle at 35% 35%, color-mix(in srgb, var(--c1) 86%, white), var(--c2));
        border: 1.5px solid color-mix(in srgb, var(--c4) 65%, var(--c2));
    }

    @@keyframes breath {
        0%, 100% {
            transform: scale(1) translateY(0);
        }

        50% {
            transform: scale(1.05) translateY(-2px);
        }
    }

    @@keyframes rippleA {
        0%, 100% {
            transform: scale(1) rotate(2deg);
        }

        50% {
            transform: scale(1.03) rotate(-1deg);
        }
    }

    @@keyframes rippleB {
        0%, 100% {
            transform: scale(.78) rotate(-7deg);
        }

        50% {
            transform: scale(.82) rotate(-2deg);
        }
    }

    @@keyframes rippleC {
        0%, 100% {
            transform: scale(.58) rotate(11deg);
        }

        50% {
            transform: scale(.62) rotate(6deg);
        }
    }

    @@keyframes coreGlow {
        0%, 100% {
            box-shadow: 0 0 10px color-mix(in srgb, var(--c3) 40%, transparent);
        }

        50% {
            box-shadow: 0 0 24px color-mix(in srgb, var(--c3) 75%, transparent);
        }
    }

    .mood-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 20px;
        border-radius: 99px;
        background: rgba(255,255,255,.46);
        outline: none;
    }

        .mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.8);
            box-shadow: 0 6px 14px rgba(0,0,0,.12);
            cursor: pointer;
        }

        .mood-slider::-moz-range-thumb {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.8);
            box-shadow: 0 6px 14px rgba(0,0,0,.12);
            cursor: pointer;
        }

    .mood-label-row {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 12px;
        color: #555a74;
        font-weight: 700;
    }

    .chip-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .chip {
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 13px;
        background: rgba(255,255,255,.6);
        color: #2f334f;
    }

        .chip.active {
            background: #2f334f;
            color: #fff;
        }

    textarea {
        border-radius: 12px;
    }

    .upload-tip {
        font-size: 13px;
        color: #6c757d;
        margin-top: 4px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .media-item {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: #eef2f7;
        min-height: 100px;
    }

        .media-item.big {
            grid-row: span 2;
            min-height: 210px;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .media-type {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background: rgba(0,0,0,.55);
        color: #fff;
        font-size: 12px;
        padding: 2px 7px;
        border-radius: 20px;
    }

    .emotion-cover {
        background: radial-gradient(circle at center, rgba(255,255,255,.95), rgba(255,255,255,.35));
    }

    .emotion-caption {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 8px;
        text-align: center;
        font-weight: 700;
        color: #2a2d47;
        background: rgba(255,255,255,.65);
        border-radius: 12px;
        font-size: 12px;
        padding: 3px 6px;
    }

    .mini-art {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .mini-art .mood-art {
            width: 120px;
            height: 120px;
            filter: none;
        }
</style>

<div class="editor">
    <div class="header">
        <a href="@Url.Action("Index")">⬅</a>
        <h5 class="mb-0">Nhật ký mới</h5>
    </div>

    <div class="mood-box" id="moodBox">
        <div class="section-title text-center">Chọn cảm giác của bạn ngay lúc này</div>

        <div class="mood-art-wrap">
            <div class="mood-art shape-spiky" id="moodArt">
                <span class="layer l1"></span>
                <span class="layer l2"></span>
                <span class="layer l3"></span>
                <span class="core"></span>
            </div>
        </div>

        <div class="mood-name" id="moodName">Rất khó chịu</div>

        <input id="moodRange" class="mood-slider" type="range" min="0" max="6" value="0" />
        <div class="mood-label-row"><span>RẤT KHÓ CHỊU</span><span>RẤT DỄ CHỊU</span></div>

        <div class="section-title">Điều nào mô tả đúng nhất về cảm giác này?</div>
        <div class="chip-wrap" id="moodDescWrap"></div>

        <div class="section-title">Điều gì đang có tác động lớn nhất đối với bạn?</div>
        <div class="chip-wrap" id="moodImpactWrap"></div>
    </div>

    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="moodLevel" id="moodLevel" value="0" />
        <input type="hidden" name="moodLabel" id="moodLabel" value="Rất khó chịu" />

        <input class="form-control my-2" name="tieuDe" placeholder="Tiêu đề (không bắt buộc)" />
        <input type="date" name="ngayViet" class="form-control my-2" value="@DateTime.Now.ToString("yyyy-MM-dd")" />

        <textarea class="form-control my-2" rows="6" name="noiDung" placeholder="Hôm nay bạn cảm thấy thế nào?"></textarea>

        <input type="file" name="medias" class="form-control my-2" accept="image/*,video/*" multiple onchange="handleMediaSelection(this)" />

        <div class="upload-tip">Bạn có thể chọn nhiều ảnh + video ngắn cùng lúc.</div>
        <div class="media-grid" id="preview"></div>

        @if (ViewBag.Loi != null)
        {
            <div class="text-danger mt-2">@ViewBag.Loi</div>
        }

        <button class="btn btn-primary w-100 mt-3">💾 Lưu nhật ký</button>
    </form>
</div>

<script>
    const moodStates = [
        { name: "Rất khó chịu", shape: "shape-spiky", bg: "radial-gradient(circle at 50% 25%, #d9d2ef, #bcb0e3)", c1: "#f3ebff", c2: "#b28cf1", c3: "#7f4cc9", c4: "#f7f3ff", desc: ["Tức giận", "Lo lắng", "Sợ hãi", "Ngợp", "Xấu hổ", "Chán ghét", "Bối rối", "Nản lòng", "Khó chịu", "Ghen tị", "Căng thẳng", "Lo âu", "Tội lỗi", "Ngạc nhiên", "Vô vọng", "Bực tức", "Cô đơn", "Chán nản", "Thất vọng", "Kiệt sức", "Buồn"] },
        { name: "Khó chịu", shape: "shape-wave", bg: "radial-gradient(circle at 50% 25%, #d7e2fb, #beccef)", c1: "#f0f5ff", c2: "#9ab4ff", c3: "#587de8", c4: "#eff5ff", desc: ["Bực bội", "Căng thẳng", "Mệt mỏi", "Khó chịu", "Lúng túng", "Buồn chán", "Thiếu động lực", "Áp lực"] },
        { name: "Hơi khó chịu", shape: "shape-soft", bg: "radial-gradient(circle at 50% 25%, #dff0f8, #cbdeee)", c1: "#ebf9ff", c2: "#8cc9f3", c3: "#4a9fdb", c4: "#f2fbff", desc: ["Hơi mệt", "Lăn tăn", "Không tập trung", "Thiếu năng lượng", "Lo nhẹ", "Không thoải mái"] },
        { name: "Bình thường", shape: "shape-rings", bg: "radial-gradient(circle at 50% 25%, #e0eef2, #c9dde2)", c1: "#f4fdff", c2: "#9dd6e9", c3: "#73b8cf", c4: "#ffffff", desc: ["Hài lòng", "Bình tĩnh", "Bình yên", "Lãnh đạm", "Kiệt sức"] },
        { name: "Hơi dễ chịu", shape: "shape-pentagon", bg: "radial-gradient(circle at 50% 25%, #e4f5d8, #cce6ba)", c1: "#f2ffe6", c2: "#9ee56a", c3: "#6dc539", c4: "#fcfff6", desc: ["Nhẹ nhõm", "Thoải mái", "Dễ chịu", "Khá vui", "Ổn định", "Có hy vọng"] },
        { name: "Dễ chịu", shape: "shape-star", bg: "radial-gradient(circle at 50% 25%, #f9efc8, #eedca5)", c1: "#fff7de", c2: "#ffd94d", c3: "#f0b31f", c4: "#fffdf3", desc: ["Vui", "Lạc quan", "Hài lòng", "Tự tin", "Yêu đời", "Tích cực", "Thoả mãn"] },
        { name: "Rất dễ chịu", shape: "shape-star", bg: "radial-gradient(circle at 50% 25%, #f8e4ba, #f0cf96)", c1: "#fff7e2", c2: "#ffc85c", c3: "#f09f17", c4: "#fffdf5", desc: ["Kinh ngạc", "Phấn khích", "Ngạc nhiên", "Sôi nổi", "Hạnh phúc", "Vui vẻ", "Dũng cảm", "Tự hào", "Tự tin", "Hy vọng", "Thích thú", "Thoả mãn", "Nhẹ nhõm", "Biết ơn", "Hài lòng", "Bình tĩnh", "Bình yên"] }
    ];

    const impacts = ["Sức khỏe", "Thể dục", "Chăm sóc bản thân", "Sở thích", "Danh tính", "Tâm linh", "Cộng đồng", "Gia đình", "Bạn bè", "Bạn đời", "Hẹn hò", "Nhiệm v", "Công việc", "Giáo dục", "Du lịch", "Thời tiết", "Sự kiện hiện tại", "Tiền"];

    const selectedFiles = [];
    const selectedDescs = new Set();
    const selectedImpacts = new Set();

    function renderChips(containerId, items, targetSet) {
        const wrap = document.getElementById(containerId);
        wrap.innerHTML = "";
        items.forEach(text => {
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "chip";
            chip.innerText = text;
            chip.onclick = () => {
                if (targetSet.has(text)) {
                    targetSet.delete(text);
                    chip.classList.remove("active");
                } else {
                    targetSet.add(text);
                    chip.classList.add("active");
                }
            };
            wrap.appendChild(chip);
        });
    }

    function applyMoodArt(el, mood) {
        el.className = `mood-art ${mood.shape}`;
        el.style.setProperty("--c1", mood.c1);
        el.style.setProperty("--c2", mood.c2);
        el.style.setProperty("--c3", mood.c3);
        el.style.setProperty("--c4", mood.c4);
    }

    function updateMoodUI(level) {
        const mood = moodStates[level];
        document.getElementById("moodName").innerText = mood.name;
        document.getElementById("moodBox").style.background = mood.bg;
        document.getElementById("moodLabel").value = mood.name;
        document.getElementById("moodLevel").value = level;
        applyMoodArt(document.getElementById("moodArt"), mood);

        selectedDescs.clear();
        renderChips("moodDescWrap", mood.desc, selectedDescs);
        renderChips("moodImpactWrap", impacts, selectedImpacts);
    }

    function handleMediaSelection(input) {
        if (!input || !input.files || !input.files.length) return;
        for (const file of input.files) {
            const isExists = selectedFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified);
            if (!isExists) selectedFiles.push(file);
        }
        syncInputFiles(input);
        renderPreview();
    }

    function syncInputFiles(input) {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        input.files = dt.files;
    }

    function removeMedia(index) {
        selectedFiles.splice(index, 1);
        const input = document.querySelector('input[name="medias"]');
        if (input) syncInputFiles(input);
        renderPreview();
    }

    function moodMiniHtml(mood) {
        return `
            <div class="mini-art">
                <div class="mood-art ${mood.shape}" style="--c1:${mood.c1};--c2:${mood.c2};--c3:${mood.c3};--c4:${mood.c4}">
                    <span class="layer l1"></span>
                    <span class="layer l2"></span>
                    <span class="layer l3"></span>
                    <span class="core"></span>
                </div>
            </div>
        `;
    }

    function renderPreview() {
        const p = document.getElementById("preview");
        p.innerHTML = "";

        const moodLevel = Number(document.getElementById("moodLevel").value || 0);
        const mood = moodStates[moodLevel];

        const emotionItem = document.createElement("div");
        emotionItem.className = "media-item big emotion-cover";
        emotionItem.style.background = mood.bg;
        emotionItem.innerHTML = moodMiniHtml(mood) + `<div class="emotion-caption">${mood.name}</div>`;
        p.appendChild(emotionItem);

        selectedFiles.forEach((file, idx) => {
            const item = document.createElement("div");
            item.className = "media-item";

            if (file.type.startsWith("image")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                item.appendChild(img);
            } else if (file.type.startsWith("video")) {
                const v = document.createElement("video");
                v.src = URL.createObjectURL(file);
                v.muted = true;
                v.playsInline = true;
                v.controls = true;
                item.appendChild(v);
            }

            const badge = document.createElement("div");
            badge.className = "media-type";
            badge.innerText = file.type.startsWith("video") ? "Video" : "Ảnh";
            item.appendChild(badge);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-sm btn-light";
            removeBtn.style.position = "absolute";
            removeBtn.style.left = "8px";
            removeBtn.style.top = "8px";
            removeBtn.style.borderRadius = "20px";
            removeBtn.innerText = "✕";
            removeBtn.onclick = () => removeMedia(idx);
            item.appendChild(removeBtn);

            p.appendChild(item);
        });
    }

    document.getElementById("moodRange").addEventListener("input", (e) => {
        updateMoodUI(Number(e.target.value));
        renderPreview();
    });

    updateMoodUI(0);
    renderPreview();
</script>
