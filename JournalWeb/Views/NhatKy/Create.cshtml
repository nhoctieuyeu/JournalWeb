@{
    ViewData["Title"] = "Viết nhật ký";
}

<style>
    body {
        background: #f4f6fa;
    }

    .editor {
        max-width: 680px;
        margin: auto;
        padding: 15px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

        .header a {
            font-size: 22px;
            text-decoration: none;
        }

    .mood-box {
        border-radius: 24px;
        padding: 20px 18px 16px;
        margin-bottom: 14px;
        background: radial-gradient(circle at 50% 25%, #efeaf8, #d7d0ee);
        box-shadow: inset 0 0 40px rgba(255,255,255,.38);
    }

    .mood-title {
        font-size: 38px;
        margin-bottom: 4px;
        text-align: center;
        filter: drop-shadow(0 6px 12px rgba(255,255,255,.4));
    }

    .mood-name {
        text-align: center;
        font-weight: 800;
        font-size: 32px;
        margin-bottom: 10px;
        color: #2a2d47;
    }

    .mood-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 20px;
        border-radius: 99px;
        background: rgba(255,255,255,.35);
        outline: none;
    }

        .mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.8);
            box-shadow: 0 6px 14px rgba(0,0,0,.12);
            cursor: pointer;
        }

        .mood-slider::-moz-range-thumb {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.8);
            box-shadow: 0 6px 14px rgba(0,0,0,.12);
            cursor: pointer;
        }

    .mood-label-row {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 12px;
        color: #555a74;
        font-weight: 700;
    }

    .mood-ripple {
        width: 160px;
        height: 160px;
        margin: 8px auto;
        border-radius: 50%;
        position: relative;
        background: radial-gradient(circle at center, rgba(255,255,255,.95) 0%, rgba(255,255,255,.3) 65%, rgba(255,255,255,.08) 100%);
        animation: pulse 3.2s ease-in-out infinite;
    }

        .mood-ripple::before,
        .mood-ripple::after {
            content: "";
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,.45);
            animation: wave 3.2s linear infinite;
        }

        .mood-ripple::after {
            animation-delay: 1.2s;
            inset: -20px;
        }

    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
            filter: saturate(100%);
        }

        50% {
            transform: scale(1.06);
            filter: saturate(130%);
        }
    }

    @@keyframes wave {
        0% {
            transform: scale(.86);
            opacity: .8;
        }

        100% {
            transform: scale(1.14);
            opacity: 0;
        }
    }

    .section-title {
        font-weight: 700;
        margin: 12px 0 8px;
        color: #2f334f;
    }

    .chip-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .chip {
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 13px;
        background: rgba(255,255,255,.6);
        color: #2f334f;
    }

        .chip.active {
            background: #2f334f;
            color: #fff;
        }

    textarea {
        border-radius: 12px;
    }

    .upload-tip {
        font-size: 13px;
        color: #6c757d;
        margin-top: 4px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .media-item {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: #eef2f7;
        min-height: 100px;
    }

        .media-item.big {
            grid-row: span 2;
            min-height: 210px;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .media-type {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        font-size: 12px;
        padding: 2px 7px;
        border-radius: 20px;
    }

    .emotion-cover {
        background: radial-gradient(circle at center, rgba(255,255,255,.95), rgba(255,255,255,.35));
    }

    .emotion-caption {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 8px;
        text-align: center;
        font-weight: 700;
        color: #2a2d47;
        background: rgba(255,255,255,.65);
        border-radius: 12px;
        font-size: 12px;
        padding: 3px 6px;
    }
</style>

<div class="editor">
    <div class="header">
        <a href="@Url.Action("Index")">⬅</a>
        <h5 class="mb-0">Nhật ký mới</h5>
    </div>

    <div class="mood-box" id="moodBox">
        <div class="section-title text-center">Chọn cảm giác của bạn ngay lúc này</div>
        <div class="mood-title" id="moodIcon">💜</div>
        <div class="mood-ripple" id="moodRipple"></div>
        <div class="mood-name" id="moodName">Rất khó chịu</div>

        <input id="moodRange" class="mood-slider" type="range" min="0" max="6" value="0" />
        <div class="mood-label-row"><span>RẤT KHÓ CHỊU</span><span>RẤT DỄ CHỊU</span></div>

        <div class="section-title">Điều nào mô tả đúng nhất về cảm giác này?</div>
        <div class="chip-wrap" id="moodDescWrap"></div>

        <div class="section-title">Điều gì đang có tác động lớn nhất đối với bạn?</div>
        <div class="chip-wrap" id="moodImpactWrap"></div>
    </div>

    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="moodLevel" id="moodLevel" value="0" />
        <input type="hidden" name="moodLabel" id="moodLabel" value="Rất khó chịu" />

        <input class="form-control my-2" name="tieuDe" placeholder="Tiêu đề (không bắt buộc)" />

        <input type="date" name="ngayViet" class="form-control my-2"
               value="@DateTime.Now.ToString("yyyy-MM-dd")" />

        <textarea class="form-control my-2" rows="6"
                  name="noiDung"
                  placeholder="Hôm nay bạn cảm thấy thế nào?"></textarea>

        <input type="file" name="medias" class="form-control my-2"
               accept="image/*,video/*"
               multiple
               onchange="handleMediaSelection(this)" />

        <div class="upload-tip">Bạn có thể chọn nhiều ảnh + video ngắn cùng lúc.</div>

        <div class="media-grid" id="preview"></div>

        @if (ViewBag.Loi != null)
        {
            <div class="text-danger mt-2">@ViewBag.Loi</div>
        }

        <button class="btn btn-primary w-100 mt-3">💾 Lưu nhật ký</button>
    </form>
</div>

<script>
    const moodStates = [
        {
            name: "Rất khó chịu", icon: "💜", bg: "radial-gradient(circle at 50% 25%, #d9d2ef, #bcb0e3)", color: "#8f67d8",
            desc: ["Tức giận", "Lo lắng", "Sợ hãi", "Ngợp", "Xấu hổ", "Chán ghét", "Bối rối", "Nản lòng", "Khó chịu", "Ghen tị", "Căng thẳng", "Lo âu", "Tội lỗi", "Ngạc nhiên", "Vô vọng", "Bực tức", "Cô đơn", "Chán nản", "Thất vọng", "Kiệt sức", "Buồn"]
        },
        {
            name: "Khó chịu", icon: "🟦", bg: "radial-gradient(circle at 50% 25%, #d7e2fb, #beccef)", color: "#6d8de5",
            desc: ["Bực bội", "Căng thẳng", "Mệt mỏi", "Khó chịu", "Lúng túng", "Buồn chán", "Thiếu động lực", "Áp lực"]
        },
        {
            name: "Hơi khó chịu", icon: "🩵", bg: "radial-gradient(circle at 50% 25%, #dff0f8, #cbdeee)", color: "#67afd9",
            desc: ["Hơi mệt", "Lăn tăn", "Không tập trung", "Thiếu năng lượng", "Lo nhẹ", "Không thoải mái"]
        },
        {
            name: "Bình thường", icon: "🔵", bg: "radial-gradient(circle at 50% 25%, #e0eef2, #c9dde2)", color: "#7aa9bf",
            desc: ["Hài lòng", "Bình tĩnh", "Bình yên", "Lãnh đạm", "Kiệt sức"]
        },
        {
            name: "Hơi dễ chịu", icon: "🟢", bg: "radial-gradient(circle at 50% 25%, #e4f5d8, #cce6ba)", color: "#80bc52",
            desc: ["Nhẹ nhõm", "Thoải mái", "Dễ chịu", "Khá vui", "Ổn định", "Có hy vọng"]
        },
        {
            name: "Dễ chịu", icon: "💛", bg: "radial-gradient(circle at 50% 25%, #f9efc8, #eedca5)", color: "#d2a328",
            desc: ["Vui", "Lạc quan", "Hài lòng", "Tự tin", "Yêu đời", "Tích cực", "Thoả mãn"]
        },
        {
            name: "Rất dễ chịu", icon: "🌼", bg: "radial-gradient(circle at 50% 25%, #f8e4ba, #f0cf96)", color: "#de9b20",
            desc: ["Kinh ngạc", "Phấn khích", "Ngạc nhiên", "Sôi nổi", "Hạnh phúc", "Vui vẻ", "Dũng cảm", "Tự hào", "Tự tin", "Hy vọng", "Thích thú", "Thoả mãn", "Nhẹ nhõm", "Biết ơn", "Hài lòng", "Bình tĩnh", "Bình yên"]
        }
    ];

    const impacts = ["Sức khỏe", "Thể dục", "Chăm sóc bản thân", "Sở thích", "Danh tính", "Tâm linh", "Cộng đồng", "Gia đình", "Bạn bè", "Bạn đời", "Hẹn hò", "Nhiệm vụ", "Công việc", "Giáo dục", "Du lịch", "Thời tiết", "Sự kiện hiện tại", "Tiền"];

    const selectedFiles = [];
    const selectedDescs = new Set();
    const selectedImpacts = new Set();

    function renderChips(containerId, items, targetSet) {
        const wrap = document.getElementById(containerId);
        wrap.innerHTML = "";
        items.forEach(text => {
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "chip";
            chip.innerText = text;
            chip.onclick = () => {
                if (targetSet.has(text)) {
                    targetSet.delete(text);
                    chip.classList.remove("active");
                } else {
                    targetSet.add(text);
                    chip.classList.add("active");
                }
            };
            wrap.appendChild(chip);
        });
    }

    function updateMoodUI(level) {
        const mood = moodStates[level];
        document.getElementById("moodName").innerText = mood.name;
        document.getElementById("moodIcon").innerText = mood.icon;
        document.getElementById("moodBox").style.background = mood.bg;
        const ripple = document.getElementById("moodRipple");
        ripple.style.boxShadow = `0 0 0 1px ${mood.color}55 inset, 0 0 30px ${mood.color}33`;
        document.getElementById("moodLabel").value = mood.name;
        document.getElementById("moodLevel").value = level;

        selectedDescs.clear();
        renderChips("moodDescWrap", mood.desc, selectedDescs);
        renderChips("moodImpactWrap", impacts, selectedImpacts);
    }

    function handleMediaSelection(input) {
        if (!input || !input.files || !input.files.length) return;

        for (const file of input.files) {
            const isExists = selectedFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified);
            if (!isExists) selectedFiles.push(file);
        }

        syncInputFiles(input);
        renderPreview();
    }

    function syncInputFiles(input) {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        input.files = dt.files;
    }

    function removeMedia(index) {
        selectedFiles.splice(index, 1);
        const input = document.querySelector('input[name="medias"]');
        if (input) syncInputFiles(input);
        renderPreview();
    }

    function renderPreview() {
        const p = document.getElementById("preview");
        p.innerHTML = "";

        const moodLevel = Number(document.getElementById("moodLevel").value || 0);
        const mood = moodStates[moodLevel];

        const emotionItem = document.createElement("div");
        emotionItem.className = "media-item big emotion-cover";
        emotionItem.style.background = mood.bg;
        emotionItem.innerHTML = `<div class="mood-title" style="margin-top:38px; font-size:56px;">${mood.icon}</div><div class="emotion-caption">${mood.name}</div>`;
        p.appendChild(emotionItem);

        selectedFiles.forEach((file, idx) => {
            const item = document.createElement("div");
            item.className = "media-item";

            if (file.type.startsWith("image")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                item.appendChild(img);
            } else if (file.type.startsWith("video")) {
                const v = document.createElement("video");
                v.src = URL.createObjectURL(file);
                v.muted = true;
                v.playsInline = true;
                v.controls = true;
                item.appendChild(v);
            }

            const badge = document.createElement("div");
            badge.className = "media-type";
            badge.innerText = file.type.startsWith("video") ? "Video" : "Ảnh";
            item.appendChild(badge);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-sm btn-light";
            removeBtn.style.position = "absolute";
            removeBtn.style.left = "8px";
            removeBtn.style.top = "8px";
            removeBtn.style.borderRadius = "20px";
            removeBtn.innerText = "✕";
            removeBtn.onclick = () => removeMedia(idx);
            item.appendChild(removeBtn);

            p.appendChild(item);
        });
    }

    document.getElementById("moodRange").addEventListener("input", (e) => {
        updateMoodUI(Number(e.target.value));
        renderPreview();
    });

    updateMoodUI(0);
    renderPreview();
</script>
