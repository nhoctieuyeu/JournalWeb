@{
    ViewData["Title"] = "Viết nhật ký";
}

<style>
    body {
        background: #f4f6fa;
    }

    .editor {
        max-width: 680px;
        margin: auto;
        padding: 15px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

        .header a {
            font-size: 22px;
            text-decoration: none;
        }

    .mood-box {
        border-radius: 24px;
        padding: 20px 18px 16px;
        margin-bottom: 14px;
        background: radial-gradient(circle at 50% 24%, #e5def5, #c7bbe8);
        box-shadow: inset 0 0 48px rgba(255,255,255,.42);
        transition: background .28s linear, box-shadow .28s linear;
        position: relative;
        overflow: hidden;
    }

        .mood-box::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,.23), transparent 40%, rgba(255,255,255,.08));
            pointer-events: none;
        }

    .section-title {
        font-weight: 700;
        margin: 12px 0 8px;
        color: #2f334f;
        position: relative;
        z-index: 1;
    }

    .mood-name {
        text-align: center;
        font-weight: 800;
        font-size: 46px;
        margin: 10px 0 8px;
        color: #20213a;
        letter-spacing: -.4px;
        position: relative;
        z-index: 1;
    }

    .mood-art-wrap {
        display: flex;
        justify-content: center;
        margin-top: 8px;
        position: relative;
        z-index: 1;
    }

    .mood-art {
        width: 230px;
        height: 230px;
        position: relative;
        filter: drop-shadow(0 16px 24px rgba(0,0,0,.14));
        animation: floatMood 4s ease-in-out infinite;
    }

    .mood-svg,
    .mood-svg-mini {
        width: 100%;
        height: 100%;
        display: block;
        overflow: visible;
    }

        .mood-svg .layer1,
        .mood-svg .layer2,
        .mood-svg .layer3,
        .mood-svg .core,
        .mood-svg-mini .layer1,
        .mood-svg-mini .layer2,
        .mood-svg-mini .layer3,
        .mood-svg-mini .core {
            transform-origin: 50% 50%;
        }

        .mood-svg .layer1,
        .mood-svg-mini .layer1 {
            animation: rippleOuter 4.2s ease-in-out infinite;
        }

        .mood-svg .layer2,
        .mood-svg-mini .layer2 {
            animation: rippleMid 3.5s ease-in-out infinite;
        }

        .mood-svg .layer3,
        .mood-svg-mini .layer3 {
            animation: rippleInner 2.9s ease-in-out infinite;
        }

        .mood-svg .core,
        .mood-svg-mini .core {
            animation: coreBlink 2.2s ease-in-out infinite;
        }

    @@keyframes floatMood {
        0%, 100% {
            transform: translateY(0) scale(1);
        }

        50% {
            transform: translateY(-3px) scale(1.018);
        }
    }

    @@keyframes rippleOuter {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.03) rotate(-2deg);
        }
    }

    @@keyframes rippleMid {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.05) rotate(2deg);
        }
    }

    @@keyframes rippleInner {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.07) rotate(-3deg);
        }
    }

    @@keyframes coreBlink {
        0%, 100% {
            opacity: .82;
            filter: brightness(1);
        }

        50% {
            opacity: 1;
            filter: brightness(1.24);
        }
    }

    .mood-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 20px;
        border-radius: 99px;
        background: rgba(255,255,255,.46);
        outline: none;
        position: relative;
        z-index: 1;
    }

        .mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.88);
            box-shadow: 0 6px 14px rgba(0,0,0,.14);
            cursor: pointer;
        }

        .mood-slider::-moz-range-thumb {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.88);
            box-shadow: 0 6px 14px rgba(0,0,0,.14);
            cursor: pointer;
        }

    .mood-label-row {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 12px;
        color: #555a74;
        font-weight: 700;
        position: relative;
        z-index: 1;
    }

    .chip-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        position: relative;
        z-index: 1;
    }

    .chip {
        border: none;
        border-radius: 999px;
        padding: 7px 13px;
        font-size: 13px;
        background: rgba(255,255,255,.72);
        color: #2f334f;
        transform: translateY(10px);
        opacity: 0;
        animation: chipIn .35s ease forwards;
        box-shadow: 0 2px 6px rgba(0,0,0,.06);
    }

        .chip.active {
            color: #fff;
            box-shadow: 0 6px 16px rgba(0,0,0,.18);
        }

    @@keyframes chipIn {
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    textarea {
        border-radius: 12px;
    }

    .upload-tip {
        font-size: 13px;
        color: #6c757d;
        margin-top: 4px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .media-item {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: #eef2f7;
        min-height: 100px;
    }

        .media-item.big {
            grid-row: span 2;
            min-height: 210px;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .media-type {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background: rgba(0,0,0,.55);
        color: #fff;
        font-size: 12px;
        padding: 2px 7px;
        border-radius: 20px;
    }

    .emotion-cover {
        background: radial-gradient(circle at center, rgba(255,255,255,.95), rgba(255,255,255,.35));
    }

    .emotion-caption {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 8px;
        text-align: center;
        font-weight: 700;
        color: #2a2d47;
        background: rgba(255,255,255,.72);
        border-radius: 12px;
        font-size: 12px;
        padding: 3px 6px;
    }

    .mini-art {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .mini-art .mood-svg-mini {
            width: 120px;
            height: 120px;
        }
</style>

<div class="editor">
    <div class="header">
        <a href="@Url.Action("Index")">⬅</a>
        <h5 class="mb-0">Nhật ký mới</h5>
    </div>

    <div class="mood-box" id="moodBox">
        <div class="section-title text-center">Chọn cảm giác của bạn ngay lúc này</div>

        <div class="mood-art-wrap">
            <div class="mood-art" id="moodArt"></div>
        </div>

        <div class="mood-name" id="moodName">Rất khó chịu</div>

        <input id="moodRange" class="mood-slider" type="range" min="0" max="6" step="0.01" value="0" />
        <div class="mood-label-row"><span>RẤT KHÓ CHỊU</span><span>RẤT DỄ CHỊU</span></div>

        <div class="section-title">Điều nào mô tả đúng nhất về cảm giác này?</div>
        <div class="chip-wrap" id="moodDescWrap"></div>

        <div class="section-title">Điều gì đang có tác động lớn nhất đối với bạn?</div>
        <div class="chip-wrap" id="moodImpactWrap"></div>
    </div>

    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="moodLevel" id="moodLevel" value="0" />
        <input type="hidden" name="moodLabel" id="moodLabel" value="Rất khó chịu" />

        <input class="form-control my-2" name="tieuDe" placeholder="Tiêu đề (không bắt buộc)" />
        <input type="date" name="ngayViet" class="form-control my-2" value="@DateTime.Now.ToString("yyyy-MM-dd")" />

        <textarea class="form-control my-2" rows="6" name="noiDung" placeholder="Hôm nay bạn cảm thấy thế nào?"></textarea>

        <input type="file" name="medias" class="form-control my-2" accept="image/*,video/*" multiple onchange="handleMediaSelection(this)" />

        <div class="upload-tip">Bạn có thể chọn nhiều ảnh + video ngắn cùng lúc.</div>
        <div class="media-grid" id="preview"></div>

        @if (ViewBag.Loi != null)
        {
            <div class="text-danger mt-2">@ViewBag.Loi</div>
        }

        <button class="btn btn-primary w-100 mt-3">💾 Lưu nhật ký</button>
    </form>
</div>

<script>
    const moodStates = [
        { name: "Rất khó chịu", top: "#d9d2ef", bottom: "#bcb0e3", c1: "#f4ebff", c2: "#c39aff", c3: "#7c4bc4", petals: 14, sharp: 2.6, amp: .26, desc: ["Tức giận", "Lo lắng", "Sợ hãi", "Ngợp", "Xấu hổ", "Chán ghét", "Bối rối", "Nản lòng", "Khó chịu", "Ghen tị", "Căng thẳng", "Lo âu", "Tội lỗi", "Ngạc nhiên", "Vô vọng", "Bực tức", "Cô đơn", "Chán nản", "Thất vọng", "Kiệt sức", "Buồn"] },
        { name: "Khó chịu", top: "#d7e2fb", bottom: "#beccef", c1: "#eef4ff", c2: "#9fb8ff", c3: "#5278e5", petals: 11, sharp: 2.1, amp: .22, desc: ["Bực bội", "Căng thẳng", "Mệt mỏi", "Khó chịu", "Lúng túng", "Buồn chán", "Thiếu động lực", "Áp lực"] },
        { name: "Hơi khó chịu", top: "#dff0f8", bottom: "#cbdeee", c1: "#ecf8ff", c2: "#92cdf5", c3: "#4a9fdb", petals: 8, sharp: 1.45, amp: .16, desc: ["Hơi mệt", "Lăn tăn", "Không tập trung", "Thiếu năng lượng", "Lo nhẹ", "Không thoải mái"] },
        { name: "Bình thường", top: "#e0eef2", bottom: "#c9dde2", c1: "#f6fdff", c2: "#a8dcee", c3: "#77b8cf", rings: true, petals: 0, sharp: 1, amp: .03, desc: ["Hài lòng", "Bình tĩnh", "Bình yên", "Lãnh đạm", "Kiệt sức"] },
        { name: "Hơi dễ chịu", top: "#e4f5d8", bottom: "#cce6ba", c1: "#f2ffe7", c2: "#a5e86f", c3: "#6bc436", petals: 5, sharp: 1.05, amp: .11, desc: ["Nhẹ nhõm", "Thoải mái", "Dễ chịu", "Khá vui", "Ổn định", "Có hy vọng"] },
        { name: "Dễ chịu", top: "#f9efc8", bottom: "#eedca5", c1: "#fff8df", c2: "#ffde58", c3: "#f0b21f", petals: 7, sharp: 1.28, amp: .17, desc: ["Vui", "Lạc quan", "Hài lòng", "Tự tin", "Yêu đời", "Tích cực", "Thoả mãn"] },
        { name: "Rất dễ chịu", top: "#f8e4ba", bottom: "#f0cf96", c1: "#fff7e3", c2: "#ffc75f", c3: "#f09d17", petals: 9, sharp: 0.9, amp: .22, desc: ["Kinh ngạc", "Phấn khích", "Ngạc nhiên", "Sôi nổi", "Hạnh phúc", "Vui vẻ", "Dũng cảm", "Tự hào", "Tự tin", "Hy vọng", "Thích thú", "Thoả mãn", "Nhẹ nhõm", "Biết ơn", "Hài lòng", "Bình tĩnh", "Bình yên"] }
    ];

    const impacts = ["Sức khỏe", "Thể dục", "Chăm sóc bản thân", "Sở thích", "Danh tính", "Tâm linh", "Cộng đồng", "Gia đình", "Bạn bè", "Bạn đời", "Hẹn hò", "Nhiệm vụ", "Công việc", "Giáo dục", "Du lịch", "Thời tiết", "Sự kiện hiện tại", "Tiền"];

    const selectedFiles = [];
    const selectedDescs = new Set();
    const selectedImpacts = new Set();

    const hexToRgb = (hex) => {
        const n = hex.replace('#', '');
        const num = parseInt(n, 16);
        return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
    };

    const rgbToHex = ({ r, g, b }) => `#${[r,g,b].map(v => Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0')).join('')}`;
    const lerp = (a, b, t) => a + (b - a) * t;

    function lerpHex(h1, h2, t) {
        const a = hexToRgb(h1), b = hexToRgb(h2);
        return rgbToHex({ r: lerp(a.r,b.r,t), g: lerp(a.g,b.g,t), b: lerp(a.b,b.b,t) });
    }

    function moodInterpolated(value) {
        const lo = Math.max(0, Math.min(6, Math.floor(value)));
        const hi = Math.max(0, Math.min(6, Math.ceil(value)));
        const t = value - lo;
        const A = moodStates[lo];
        const B = moodStates[hi];

        return {
            name: moodStates[Math.round(value)].name,
            top: lerpHex(A.top, B.top, t),
            bottom: lerpHex(A.bottom, B.bottom, t),
            c1: lerpHex(A.c1, B.c1, t),
            c2: lerpHex(A.c2, B.c2, t),
            c3: lerpHex(A.c3, B.c3, t),
            petals: lerp(A.petals || 0, B.petals || 0, t),
            sharp: lerp(A.sharp || 1, B.sharp || 1, t),
            amp: lerp(A.amp || 0, B.amp || 0, t),
            rings: (A.rings && B.rings) || (Math.round(value) === 3)
        };
    }

    function flowerPoints(radius, petals, amp, sharp, phase = 0, count = 260) {
        let pts = [];
        for (let i = 0; i < count; i++) {
            const t = (Math.PI * 2 * i) / count;
            const wave = Math.sin(petals * t + phase);
            const softened = Math.sign(wave) * Math.pow(Math.abs(wave), sharp);
            const r = radius * (1 + amp * softened);
            const x = 50 + r * Math.cos(t);
            const y = 50 + r * Math.sin(t);
            pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
        }
        return pts.join(' ');
    }

    function buildMoodSvg(mood, mini = false, idPrefix = "m") {
        const cls = mini ? 'mood-svg-mini' : 'mood-svg';
        const petalBase = Math.max(4, mood.petals || 6);
        const grad1 = `${idPrefix}-g1`;
        const gradA = `${idPrefix}-ga`;
        const gradB = `${idPrefix}-gb`;
        const gradC = `${idPrefix}-gc`;

        if (mood.rings) {
            return `<svg class="${cls}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle class="layer1" cx="50" cy="50" r="42" fill="none" stroke="${mood.c1}" stroke-width="1.2"/>
                <circle class="layer2" cx="50" cy="50" r="31" fill="none" stroke="${mood.c2}" stroke-width="1.6"/>
                <circle class="layer3" cx="50" cy="50" r="20" fill="url(#${grad1})" stroke="${mood.c3}" stroke-width="1.2"/>
                <circle class="core" cx="50" cy="50" r="4.5" fill="#fff"/>
                <defs>
                    <radialGradient id="${grad1}" cx="35%" cy="30%">
                        <stop offset="0%" stop-color="#ffffff"/>
                        <stop offset="100%" stop-color="${mood.c2}"/>
                    </radialGradient>
                </defs>
            </svg>`;
        }

        const p1 = flowerPoints(39, petalBase, mood.amp, mood.sharp, 0);
        const p2 = flowerPoints(30, Math.max(3, petalBase - 1), Math.max(.04, mood.amp - .04), Math.max(.8, mood.sharp - .18), .35);
        const p3 = flowerPoints(21, Math.max(3, petalBase - 2), Math.max(.03, mood.amp - .08), Math.max(.7, mood.sharp - .25), -.35);

        return `<svg class="${cls}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="${gradA}" cx="30%" cy="28%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="${mood.c1}"/></radialGradient>
                <radialGradient id="${gradB}" cx="35%" cy="32%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="${mood.c2}"/></radialGradient>
                <radialGradient id="${gradC}" cx="40%" cy="34%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="${mood.c3}"/></radialGradient>
            </defs>
            <polygon class="layer1" points="${p1}" fill="url(#${gradA})" stroke="${mood.c3}" stroke-opacity=".45" stroke-width=".9"/>
            <polygon class="layer2" points="${p2}" fill="url(#${gradB})" stroke="${mood.c3}" stroke-opacity=".58" stroke-width="1"/>
            <polygon class="layer3" points="${p3}" fill="url(#${gradC})" stroke="${mood.c3}" stroke-opacity=".78" stroke-width="1.1"/>
            <circle class="core" cx="50" cy="50" r="2.8" fill="#fff"/>
        </svg>`;
    }

    function renderChips(containerId, items, targetSet, activeColor) {
        const wrap = document.getElementById(containerId);
        wrap.innerHTML = "";
        items.forEach((text, idx) => {
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "chip";
            chip.style.animationDelay = `${idx * 22}ms`;
            chip.innerText = text;
            chip.onclick = () => {
                if (targetSet.has(text)) {
                    targetSet.delete(text);
                    chip.classList.remove("active");
                    chip.style.background = "rgba(255,255,255,.72)";
                } else {
                    targetSet.add(text);
                    chip.classList.add("active");
                    chip.style.background = activeColor;
                }
            };
            wrap.appendChild(chip);
        });
    }

    function updateMoodUI(rawValue) {
        const mood = moodInterpolated(rawValue);
        const step = Math.round(rawValue);

        const box = document.getElementById("moodBox");
        box.style.background = `radial-gradient(circle at 50% 24%, ${mood.top}, ${mood.bottom})`;

        document.getElementById("moodName").innerText = mood.name;
        document.getElementById("moodLabel").value = moodStates[step].name;
        document.getElementById("moodLevel").value = step;
        document.getElementById("moodArt").innerHTML = buildMoodSvg(mood, false, "main");

        selectedDescs.clear();
        renderChips("moodDescWrap", moodStates[step].desc, selectedDescs, mood.c3);
        renderChips("moodImpactWrap", impacts, selectedImpacts, mood.c3);
    }

    function handleMediaSelection(input) {
        if (!input || !input.files || !input.files.length) return;
        for (const file of input.files) {
            const isExists = selectedFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified);
            if (!isExists) selectedFiles.push(file);
        }
        syncInputFiles(input);
        renderPreview();
    }

    function syncInputFiles(input) {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        input.files = dt.files;
    }

    function removeMedia(index) {
        selectedFiles.splice(index, 1);
        const input = document.querySelector('input[name="medias"]');
        if (input) syncInputFiles(input);
        renderPreview();
    }

    function moodMiniHtml(mood) {
        return `<div class="mini-art">${buildMoodSvg(mood, true, "preview")}</div>`;
    }

    function renderPreview() {
        const p = document.getElementById("preview");
        p.innerHTML = "";

        const raw = Number(document.getElementById("moodRange").value || 0);
        const mood = moodInterpolated(raw);

        const emotionItem = document.createElement("div");
        emotionItem.className = "media-item big emotion-cover";
        emotionItem.style.background = `radial-gradient(circle at 50% 24%, ${mood.top}, ${mood.bottom})`;
        emotionItem.innerHTML = moodMiniHtml(mood) + `<div class="emotion-caption">${mood.name}</div>`;
        p.appendChild(emotionItem);

        selectedFiles.forEach((file, idx) => {
            const item = document.createElement("div");
            item.className = "media-item";

            if (file.type.startsWith("image")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                item.appendChild(img);
            } else if (file.type.startsWith("video")) {
                const v = document.createElement("video");
                v.src = URL.createObjectURL(file);
                v.muted = true;
                v.playsInline = true;
                v.controls = true;
                item.appendChild(v);
            }

            const badge = document.createElement("div");
            badge.className = "media-type";
            badge.innerText = file.type.startsWith("video") ? "Video" : "Ảnh";
            item.appendChild(badge);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-sm btn-light";
            removeBtn.style.position = "absolute";
            removeBtn.style.left = "8px";
            removeBtn.style.top = "8px";
            removeBtn.style.borderRadius = "20px";
            removeBtn.innerText = "✕";
            removeBtn.onclick = () => removeMedia(idx);
            item.appendChild(removeBtn);

            p.appendChild(item);
        });
    }

    document.getElementById("moodRange").addEventListener("input", (e) => {
        const value = Number(e.target.value);
        updateMoodUI(value);
        renderPreview();
    });

    updateMoodUI(0);
    renderPreview();
</script>
