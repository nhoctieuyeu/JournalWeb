@using JournalWeb.Models
@using System.Text.Json
@{
    ViewData["Title"] = "Viết nhật ký";

    var camXucList = ViewBag.CamXucList as List<CamXuc> ?? new List<CamXuc>();
    var danhMucList = ViewBag.DanhMucList as List<DanhMuc> ?? new List<DanhMuc>();
}

<style>
    body {
        background: #f4f6fa;
    }

    .editor {
        max-width: 680px;
        margin: auto;
        padding: 15px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

        .header a {
            font-size: 22px;
            text-decoration: none;
        }

    .mood-box {
        border-radius: 24px;
        padding: 20px 18px 16px;
        margin-bottom: 14px;
        background: radial-gradient(circle at 50% 24%, #e5def5, #c7bbe8);
        box-shadow: inset 0 0 48px rgba(255,255,255,.42);
        transition: background .28s linear, box-shadow .28s linear;
        position: relative;
        overflow: hidden;
    }

        .mood-box::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,.23), transparent 40%, rgba(255,255,255,.08));
            pointer-events: none;
        }

    .section-title {
        font-weight: 700;
        margin: 12px 0 8px;
        color: #2f334f;
        position: relative;
        z-index: 1;
    }

    .mood-name {
        text-align: center;
        font-weight: 800;
        font-size: 46px;
        margin: 10px 0 8px;
        color: #20213a;
        letter-spacing: -.4px;
        position: relative;
        z-index: 1;
    }

    .mood-art-wrap {
        display: flex;
        justify-content: center;
        margin-top: 8px;
        position: relative;
        z-index: 1;
    }

    .mood-art {
        width: 230px;
        height: 230px;
        position: relative;
        filter: drop-shadow(0 16px 24px rgba(0,0,0,.14));
        animation: floatMood 4s ease-in-out infinite;
    }

    .mood-svg,
    .mood-svg-mini {
        width: 100%;
        height: 100%;
        display: block;
        overflow: visible;
    }

        .mood-svg .layer1,
        .mood-svg .layer2,
        .mood-svg .layer3,
        .mood-svg .core,
        .mood-svg-mini .layer1,
        .mood-svg-mini .layer2,
        .mood-svg-mini .layer3,
        .mood-svg-mini .core {
            transform-origin: 50% 50%;
        }

        .mood-svg .layer1,
        .mood-svg-mini .layer1 {
            animation: rippleOuter 4.2s ease-in-out infinite;
        }

        .mood-svg .layer2,
        .mood-svg-mini .layer2 {
            animation: rippleMid 3.5s ease-in-out infinite;
        }

        .mood-svg .layer3,
        .mood-svg-mini .layer3 {
            animation: rippleInner 2.9s ease-in-out infinite;
        }

        .mood-svg .core,
        .mood-svg-mini .core {
            animation: coreBlink 2.2s ease-in-out infinite;
        }

    @@keyframes floatMood {
        0%, 100% {
            transform: translateY(0) scale(1);
        }

        50% {
            transform: translateY(-3px) scale(1.018);
        }
    }

    @@keyframes rippleOuter {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.03) rotate(-2deg);
        }
    }

    @@keyframes rippleMid {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.05) rotate(2deg);
        }
    }

    @@keyframes rippleInner {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.07) rotate(-3deg);
        }
    }

    @@keyframes coreBlink {
        0%, 100% {
            opacity: .82;
            filter: brightness(1);
        }

        50% {
            opacity: 1;
            filter: brightness(1.24);
        }
    }

    .mood-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 20px;
        border-radius: 99px;
        background: rgba(255,255,255,.46);
        outline: none;
        position: relative;
        z-index: 1;
    }

        .mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.88);
            box-shadow: 0 6px 14px rgba(0,0,0,.14);
            cursor: pointer;
        }

        .mood-slider::-moz-range-thumb {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 2px solid rgba(255,255,255,.88);
            box-shadow: 0 6px 14px rgba(0,0,0,.14);
            cursor: pointer;
        }

    .mood-label-row {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 12px;
        color: #555a74;
        font-weight: 700;
        position: relative;
        z-index: 1;
    }

    .chip-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        position: relative;
        z-index: 1;
    }

    .chip {
        border: none;
        border-radius: 999px;
        padding: 7px 13px;
        font-size: 13px;
        background: rgba(255,255,255,.72);
        color: #2f334f;
        transform: translateY(10px);
        opacity: 0;
        animation: chipIn .35s ease forwards;
        box-shadow: 0 2px 6px rgba(0,0,0,.06);
        cursor: pointer;
        transition: all 0.1s ease;
    }

        .chip.active {
            color: #fff;
            box-shadow: 0 6px 16px rgba(0,0,0,.18);
        }

    @@keyframes chipIn {
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    textarea {
        border-radius: 12px;
    }

    .upload-tip {
        font-size: 13px;
        color: #6c757d;
        margin-top: 4px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .media-item {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: #eef2f7;
        min-height: 100px;
    }

        .media-item.big {
            grid-row: span 2;
            min-height: 210px;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .media-type {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background: rgba(0,0,0,.55);
        color: #fff;
        font-size: 12px;
        padding: 2px 7px;
        border-radius: 20px;
    }

    .emotion-cover {
        background: radial-gradient(circle at center, rgba(255,255,255,.95), rgba(255,255,255,.35));
    }

    .emotion-caption {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 8px;
        text-align: center;
        font-weight: 700;
        color: #2a2d47;
        background: rgba(255,255,255,.72);
        border-radius: 12px;
        font-size: 12px;
        padding: 3px 6px;
    }

    .mini-art {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .mini-art .mood-svg-mini {
            width: 120px;
            height: 120px;
        }
</style>

<div class="editor">
    <div class="header">
        <a href="@Url.Action("Index")">⬅</a>
        <h5 class="mb-0">Nhật ký mới</h5>
    </div>

    <div class="mood-box" id="moodBox">
        <div class="section-title text-center">Chọn cảm giác của bạn ngay lúc này</div>

        <div class="mood-art-wrap">
            <div class="mood-art" id="moodArt"></div>
        </div>

        <div class="mood-name" id="moodName">Rất khó chịu</div>

        <input id="moodRange" class="mood-slider" type="range" min="1" max="7" step="1" value="1" />
        <div class="mood-label-row"><span>RẤT KHÓ CHỊU</span><span>RẤT DỄ CHỊU</span></div>

        <div class="section-title">Điều nào mô tả đúng nhất về cảm giác này?</div>
        <div class="chip-wrap" id="moodDescWrap"></div>

        <div class="section-title">Điều gì đang có tác động lớn nhất đối với bạn?</div>
        <div class="chip-wrap" id="moodImpactWrap"></div>
    </div>

    <form method="post" enctype="multipart/form-data" id="journalForm">
        @Html.AntiForgeryToken()

        <input type="hidden" name="mucDoId" id="mucDoId" value="1" />
        <div id="selectedChiTietContainer"></div>
        <div id="selectedDanhMucContainer"></div>

        <input class="form-control my-2" name="tieuDe" placeholder="Tiêu đề (không bắt buộc)" />
        <input type="date" name="ngayViet" class="form-control my-2" value="@DateTime.Now.ToString("yyyy-MM-dd")" />

        <textarea class="form-control my-2" rows="6" name="noiDung" placeholder="Hôm nay bạn cảm thấy thế nào?" required></textarea>

        <input type="file" name="medias" class="form-control my-2" accept="image/*,video/*" multiple onchange="handleMediaSelection(this)" />

        <div class="upload-tip">Bạn có thể chọn nhiều ảnh + video ngắn cùng lúc.</div>
        <div class="media-grid" id="preview"></div>

        @if (ViewBag.Loi != null)
        {
            <div class="text-danger mt-2">@ViewBag.Loi</div>
        }

        <button class="btn btn-primary w-100 mt-3">💾 Lưu nhật ký</button>
    </form>
</div>

<script>
    // ------------------------------------------------------------
    // Dữ liệu được truyền từ ViewBag (server)
    // ------------------------------------------------------------
    const camXucList = @Html.Raw(JsonSerializer.Serialize(camXucList.Select(c => new {
        c.CamXucId,
        c.TenCamXuc,
        c.MaMauGradient,
        ChiTiets = c.CamXucChiTiets.OrderBy(ct => ct.ThuTu).Select(ct => new { ct.ChiTietId, ct.TenChiTiet })
    })));

    const danhMucList = @Html.Raw(JsonSerializer.Serialize(danhMucList.Select(d => new {
        d.DanhMucId,
        d.TenDanhMuc
    })));

    // ------------------------------------------------------------
    // Biến toàn cục
    // ------------------------------------------------------------
    let currentMucDoId = 1;
    const selectedChiTietIds = new Set();
    const selectedDanhMucIds = new Set();
    const selectedFiles = [];

    // ------------------------------------------------------------
    // Khởi tạo giao diện
    // ------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function () {
        updateMoodUI(currentMucDoId);
        renderChipsForMood(currentMucDoId);
        renderDanhMucChips();
        renderPreview();
    });

    // ------------------------------------------------------------
    // Xử lý slider thay đổi mức độ
    // ------------------------------------------------------------
    document.getElementById('moodRange').addEventListener('input', function (e) {
        const mucDo = parseInt(e.target.value);
        currentMucDoId = mucDo;
        document.getElementById('mucDoId').value = mucDo;
        updateMoodUI(mucDo);
        renderChipsForMood(mucDo);
        renderPreview(); // cập nhật preview mood
    });

    // ------------------------------------------------------------
    // Cập nhật màu sắc, tên cảm xúc, SVG
    // ------------------------------------------------------------
    function updateMoodUI(mucDo) {
        const mood = camXucList.find(c => c.CamXucId === mucDo);
        if (!mood) return;

        const box = document.getElementById("moodBox");
        box.style.background = mood.MaMauGradient;
        document.getElementById("moodName").innerText = mood.TenCamXuc;
        document.getElementById("moodArt").innerHTML = buildMoodSvg(mood, false);
    }

    // ------------------------------------------------------------
    // Render các chip cảm xúc chi tiết theo mức độ
    // ------------------------------------------------------------
    function renderChipsForMood(mucDo) {
        const mood = camXucList.find(c => c.CamXucId === mucDo);
        if (!mood) return;

        const wrap = document.getElementById("moodDescWrap");
        wrap.innerHTML = "";

        mood.ChiTiets.forEach((chip, idx) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "chip";
            btn.innerText = chip.TenChiTiet;
            btn.dataset.chitietid = chip.ChiTietId;
            btn.style.animationDelay = `${idx * 20}ms`;

            if (selectedChiTietIds.has(chip.ChiTietId)) {
                btn.classList.add("active");
                btn.style.background = mood.MaMauGradient;
            }

            btn.onclick = function () {
                const id = parseInt(this.dataset.chitietid);
                if (selectedChiTietIds.has(id)) {
                    selectedChiTietIds.delete(id);
                    this.classList.remove("active");
                    this.style.background = "rgba(255,255,255,.72)";
                } else {
                    selectedChiTietIds.add(id);
                    this.classList.add("active");
                    this.style.background = mood.MaMauGradient;
                }
                updateHiddenInputs();
            };
            wrap.appendChild(btn);
        });
    }

    // ------------------------------------------------------------
    // Render danh mục tác động
    // ------------------------------------------------------------
    function renderDanhMucChips() {
        const wrap = document.getElementById("moodImpactWrap");
        wrap.innerHTML = "";

        danhMucList.forEach((dm, idx) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "chip";
            btn.innerText = dm.TenDanhMuc;
            btn.dataset.danhmucid = dm.DanhMucId;
            btn.style.animationDelay = `${idx * 20}ms`;

            if (selectedDanhMucIds.has(dm.DanhMucId)) {
                btn.classList.add("active");
                btn.style.background = "#007aff";
            }

            btn.onclick = function () {
                const id = parseInt(this.dataset.danhmucid);
                if (selectedDanhMucIds.has(id)) {
                    selectedDanhMucIds.delete(id);
                    this.classList.remove("active");
                    this.style.background = "rgba(255,255,255,.72)";
                } else {
                    selectedDanhMucIds.add(id);
                    this.classList.add("active");
                    this.style.background = "#007aff";
                }
                updateHiddenInputs();
            };
            wrap.appendChild(btn);
        });
    }

    // ------------------------------------------------------------
    // Cập nhật input hidden gửi lên server
    // ------------------------------------------------------------
    function updateHiddenInputs() {
        const chiTietContainer = document.getElementById("selectedChiTietContainer");
        chiTietContainer.innerHTML = "";
        selectedChiTietIds.forEach(id => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "chiTietIds";
            input.value = id;
            chiTietContainer.appendChild(input);
        });

        const danhMucContainer = document.getElementById("selectedDanhMucContainer");
        danhMucContainer.innerHTML = "";
        selectedDanhMucIds.forEach(id => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "danhMucIds";
            input.value = id;
            danhMucContainer.appendChild(input);
        });
    }

    // ------------------------------------------------------------
    // Xử lý upload media & preview
    // ------------------------------------------------------------
    function handleMediaSelection(input) {
        if (!input || !input.files || !input.files.length) return;
        for (const file of input.files) {
            const isExists = selectedFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified);
            if (!isExists) selectedFiles.push(file);
        }
        syncInputFiles(input);
        renderPreview();
    }

    function syncInputFiles(input) {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        input.files = dt.files;
    }

    function removeMedia(index) {
        selectedFiles.splice(index, 1);
        const input = document.querySelector('input[name="medias"]');
        if (input) syncInputFiles(input);
        renderPreview();
    }

    // ------------------------------------------------------------
    // Render preview media + mood
    // ------------------------------------------------------------
    function renderPreview() {
        const p = document.getElementById("preview");
        p.innerHTML = "";

        const mood = camXucList.find(c => c.CamXucId === currentMucDoId) || camXucList[0];
        if (!mood) return;

        const emotionItem = document.createElement("div");
        emotionItem.className = "media-item big emotion-cover";
        emotionItem.style.background = mood.MaMauGradient;
        emotionItem.innerHTML = `<div class="mini-art">${buildMoodSvg(mood, true)}</div><div class="emotion-caption">${mood.TenCamXuc}</div>`;
        p.appendChild(emotionItem);

        selectedFiles.forEach((file, idx) => {
            const item = document.createElement("div");
            item.className = "media-item";

            if (file.type.startsWith("image")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                item.appendChild(img);
            } else if (file.type.startsWith("video")) {
                const v = document.createElement("video");
                v.src = URL.createObjectURL(file);
                v.muted = true;
                v.playsInline = true;
                v.controls = true;
                item.appendChild(v);
            }

            const badge = document.createElement("div");
            badge.className = "media-type";
            badge.innerText = file.type.startsWith("video") ? "Video" : "Ảnh";
            item.appendChild(badge);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-sm btn-light";
            removeBtn.style.position = "absolute";
            removeBtn.style.left = "8px";
            removeBtn.style.top = "8px";
            removeBtn.style.borderRadius = "20px";
            removeBtn.innerText = "✕";
            removeBtn.onclick = () => removeMedia(idx);
            item.appendChild(removeBtn);

            p.appendChild(item);
        });
    }

    // ------------------------------------------------------------
    // Hàm tạo SVG mood (giữ nguyên từ bản cũ)
    // ------------------------------------------------------------
    function flowerPoints(radius, petals, amp, sharp, phase = 0, count = 260) {
        let pts = [];
        for (let i = 0; i < count; i++) {
            const t = (Math.PI * 2 * i) / count;
            const wave = Math.sin(petals * t + phase);
            const softened = Math.sign(wave) * Math.pow(Math.abs(wave), sharp);
            const r = radius * (1 + amp * softened);
            const x = 50 + r * Math.cos(t);
            const y = 50 + r * Math.sin(t);
            pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
        }
        return pts.join(' ');
    }

    function buildMoodSvg(mood, mini = false) {
        const cls = mini ? 'mood-svg-mini' : 'mood-svg';
        const petalBase = mood.CamXucId === 4 ? 0 : (mood.CamXucId === 1 ? 14 : mood.CamXucId === 2 ? 11 : mood.CamXucId === 3 ? 8 : mood.CamXucId === 5 ? 5 : mood.CamXucId === 6 ? 7 : 9);
        const amp = mood.CamXucId === 4 ? 0.03 : [0.26,0.22,0.16,0.03,0.11,0.17,0.22][mood.CamXucId-1];
        const sharp = mood.CamXucId === 4 ? 1 : [2.6,2.1,1.45,1,1.05,1.28,0.9][mood.CamXucId-1];
        const c1 = mood.MaMauGradient.includes('#') ? '#ffffff' : '#f0f0f0';
        const c2 = '#c0c0c0';
        const c3 = '#a0a0a0';

        if (mood.CamXucId === 4) {
            return `<svg class="${cls}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle class="layer1" cx="50" cy="50" r="42" fill="none" stroke="${c2}" stroke-width="1.2"/>
                <circle class="layer2" cx="50" cy="50" r="31" fill="none" stroke="${c1}" stroke-width="1.6"/>
                <circle class="layer3" cx="50" cy="50" r="20" fill="white" stroke="${c3}" stroke-width="1.2"/>
                <circle class="core" cx="50" cy="50" r="4.5" fill="#fff"/>
            </svg>`;
        }

        const p1 = flowerPoints(39, petalBase, amp, sharp, 0);
        const p2 = flowerPoints(30, Math.max(3, petalBase - 1), Math.max(.04, amp - .04), Math.max(.8, sharp - .18), .35);
        const p3 = flowerPoints(21, Math.max(3, petalBase - 2), Math.max(.03, amp - .08), Math.max(.7, sharp - .25), -.35);

        return `<svg class="${cls}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <polygon class="layer1" points="${p1}" fill="white" stroke="${c3}" stroke-opacity=".45" stroke-width=".9"/>
            <polygon class="layer2" points="${p2}" fill="white" stroke="${c3}" stroke-opacity=".58" stroke-width="1"/>
            <polygon class="layer3" points="${p3}" fill="white" stroke="${c3}" stroke-opacity=".78" stroke-width="1.1"/>
            <circle class="core" cx="50" cy="50" r="2.8" fill="#fff"/>
        </svg>`;
    }
</script>