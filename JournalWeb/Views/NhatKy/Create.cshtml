@{
    ViewData["Title"] = "Viết nhật ký";
}

<style>
    body {
        background: #f4f6fa;
    }

    .editor {
        max-width: 640px;
        margin: auto;
        padding: 15px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

        .header a {
            font-size: 22px;
            text-decoration: none;
        }

    textarea {
        border-radius: 12px;
    }

    .upload-tip {
        font-size: 13px;
        color: #6c757d;
        margin-top: 4px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .media-item {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: #eef2f7;
        min-height: 100px;
    }

        .media-item.big {
            grid-row: span 2;
            min-height: 210px;
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .media-type {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        font-size: 12px;
        padding: 2px 7px;
        border-radius: 20px;
    }

</style>

<div class="editor">
    <div class="header">
        <a href="@Url.Action("Index")">⬅</a>
        <h5 class="mb-0">Nhật ký mới</h5>
    </div>

    <form method="post" enctype="multipart/form-data">
        <input class="form-control my-2" name="tieuDe" placeholder="Tiêu đề (không bắt buộc)" />

        <input type="date" name="ngayViet" class="form-control my-2"
               value="@DateTime.Now.ToString("yyyy-MM-dd")" />

        <textarea class="form-control my-2" rows="6"
                  name="noiDung"
                  placeholder="Hôm nay bạn cảm thấy thế nào?"></textarea>

        <input type="file" name="medias" class="form-control my-2"
               accept="image/*,video/*"
               multiple
               onchange="handleMediaSelection(this)" />

        <div class="upload-tip">Bạn có thể chọn nhiều ảnh + video ngắn cùng lúc.</div>

        <div class="media-grid" id="preview"></div>

        @if (ViewBag.Loi != null)
        {
            <div class="text-danger mt-2">@ViewBag.Loi</div>
        }

        <button class="btn btn-primary w-100 mt-3">💾 Lưu nhật ký</button>
    </form>
</div>

<script>
    const selectedFiles = [];

    function handleMediaSelection(input) {
        if (!input || !input.files || !input.files.length) return;

        for (const file of input.files) {
            const isExists = selectedFiles.some(f =>
                f.name === file.name &&
                f.size === file.size &&
                f.lastModified === file.lastModified
            );

            if (!isExists) {
                selectedFiles.push(file);
            }
        }

        syncInputFiles(input);
        renderPreview();
    }

    function syncInputFiles(input) {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        input.files = dt.files;
    }

    function removeMedia(index) {
        selectedFiles.splice(index, 1);

        const input = document.querySelector('input[name="medias"]');
        if (input) {
            syncInputFiles(input);
        }

        renderPreview();
    }

    function renderPreview() {
        const p = document.getElementById("preview");
        p.innerHTML = "";

        if (!selectedFiles.length) return;

        selectedFiles.forEach((file, index) => {
            const item = document.createElement("div");
            item.className = "media-item" + (index === 0 ? " big" : "");

            if (file.type.startsWith("image")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                item.appendChild(img);
            } else if (file.type.startsWith("video")) {
                const v = document.createElement("video");
                v.src = URL.createObjectURL(file);
                v.muted = true;
                v.playsInline = true;
                v.controls = true;
                item.appendChild(v);
            }

            const badge = document.createElement("div");
            badge.className = "media-type";
            badge.innerText = file.type.startsWith("video") ? "Video" : "Ảnh";
            item.appendChild(badge);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-sm btn-light";
            removeBtn.style.position = "absolute";
            removeBtn.style.left = "8px";
            removeBtn.style.top = "8px";
            removeBtn.style.borderRadius = "20px";
            removeBtn.innerText = "✕";
            removeBtn.onclick = () => removeMedia(index);
            item.appendChild(removeBtn);

            p.appendChild(item);
        });
    }
</script>
