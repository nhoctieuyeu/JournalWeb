@using System.Linq
@model List<JournalWeb.Models.JournalMonthGroupVm>

@{
    ViewData["Title"] = "Nhật ký";
}

<script src="https://cdn.tailwindcss.com"></script>

<div class="min-h-screen bg-[#F2F2F7] pb-28">
    <div class="max-w-[1200px] mx-auto px-4 md:px-6 pt-6">
        <div class="flex items-center justify-between mb-5">
            <button type="button" onclick="history.back()" class="w-12 h-12 rounded-full bg-white/80 border border-white shadow-sm text-2xl leading-none">←</button>
            <div class="flex items-center gap-3 bg-white/80 border border-white rounded-full px-5 py-2 shadow-sm">
                <button type="button" class="text-3xl leading-none">⌕</button>
                <button type="button" class="text-3xl leading-none">⋯</button>
            </div>
        </div>

        <h1 class="text-5xl font-extrabold tracking-tight mb-6">Nhật ký</h1>

        @if (Model == null || !Model.Any())
        {
            <div class="rounded-3xl bg-white p-8 text-center text-gray-500 shadow-sm">Chưa có nhật ký nào.</div>
        }
        else
        {
            @foreach (var group in Model)
            {
                <h2 class="text-4xl font-bold mb-4 mt-8 first:mt-0">@group.GroupTitle</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                    @foreach (var card in group.Items)
                    {
                        var medias = card.Medias ?? new List<JournalWeb.Models.NhatKyMedia>();
                        var shown = medias.Take(4).ToList();
                        var extraCount = Math.Max(0, medias.Count - 4);
                        var bg = string.IsNullOrWhiteSpace(card.MoodColor) ? "#F7C66B" : card.MoodColor;
                        var moodStyle = bg.Contains("gradient", StringComparison.OrdinalIgnoreCase) ? bg : $"linear-gradient(180deg, #F8EAD9 0%, {bg} 100%)";
                        var moodTopic = card.GetType().GetProperty("MoodTopic")?.GetValue(card)?.ToString();
                        if (string.IsNullOrWhiteSpace(moodTopic)) moodTopic = "Các hoạt động khác";

                        <article class="rounded-[24px] bg-white shadow-sm overflow-hidden relative">
                            <div class="p-3 border border-gray-100 rounded-t-[24px]">
                                <div class="grid grid-cols-2 gap-2 h-[210px]">
                                    <div class="rounded-[18px] p-3 flex flex-col justify-between text-center"
                                         style="background: @moodStyle;">
                                        <div class="text-[20px] font-semibold text-gray-700 leading-tight">@card.MoodLabel</div>

                                        <div class="flex items-center justify-center">
                                            <div class="w-24 h-24 rounded-full bg-white/35 backdrop-blur-[2px] flex items-center justify-center text-5xl">✿</div>
                                        </div>

                                        <div class="text-[16px] text-gray-600 leading-tight">@moodTopic</div>
                                    </div>

                                    <div class="grid gap-2 @(shown.Count <= 1 ? "grid-cols-1" : shown.Count == 2 ? "grid-cols-1 grid-rows-2" : "grid-cols-2 grid-rows-2")">
                                        @if (!shown.Any())
                                        {
                                            <div class="rounded-2xl bg-gray-100 flex items-center justify-center text-gray-400 text-sm">Không có media</div>
                                        }
                                        else
                                        {
                                            for (var i = 0; i < shown.Count; i++)
                                            {
                                                var media = shown[i];
                                                var isVideo = media.LoaiMedia == "video";
                                                var isLastOverlay = extraCount > 0 && i == shown.Count - 1;

                                                <div class="relative rounded-2xl overflow-hidden bg-gray-100 @(shown.Count == 1 ? "h-full" : "")">
                                                    @if (isVideo)
                                                    {
                                                        <video src="@media.DuongDanFile" class="w-full h-full object-cover" muted playsinline></video>
                                                        <div class="absolute right-2 bottom-2 text-white text-xs font-semibold bg-black/35 rounded-lg px-2 py-1">▶ @(string.IsNullOrWhiteSpace(media.ThoiLuong) ? "0:00" : media.ThoiLuong)</div>
                                                    }
                                                    else
                                                    {
                                                        <img src="@media.DuongDanFile" alt="media" class="w-full h-full object-cover" />
                                                    }

                                                    @if (isLastOverlay)
                                                    {
                                                        <div class="absolute inset-0 bg-black/35 flex items-center justify-center">
                                                            <div class="text-white text-2xl font-bold">+@extraCount</div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="px-6 pt-5 pb-4">
                                <h3 class="text-4xl font-bold leading-tight mb-2">@(!string.IsNullOrWhiteSpace(card.TieuDe) ? card.TieuDe : "Không tiêu đề")</h3>
                                <p class="text-3xl text-gray-800 leading-snug line-clamp-2">@card.NoiDungTomTat</p>
                            </div>

                            <div class="px-6 py-3 border-t border-gray-200 flex items-center justify-between">
                                <div class="text-2xl text-gray-500">@card.DisplayDateLine</div>

                                <div class="relative">
                                    <button type="button"
                                            class="text-3xl text-gray-500 w-10 h-10"
                                            onclick="toggleMenu(@card.NhatKyId)">
                                        ⋯
                                    </button>

                                    <div id="menu-@card.NhatKyId" class="hidden absolute right-0 bottom-11 w-72 rounded-3xl bg-white shadow-xl border border-gray-100 p-3 z-40">
                                        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-gray-50 text-xl">✎ Sửa</a>
                                        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-gray-50 text-xl">🔖 Đánh dấu 1 bài viết</a>
                                        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-gray-50 text-xl">☐ Chọn nhật ký</a>
                                        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-gray-50 text-xl">🖨 In 1 bài viết</a>
                                        <hr class="my-2" />
                                        <a href="#" class="block px-4 py-3 rounded-xl hover:bg-red-50 text-xl text-red-500">🗑 Xóa 1 bài viết</a>
                                    </div>
                                </div>
                            </div>
                        </article>
                    }
                </div>
            }
        }
    </div>

    <a href="@Url.Action("Create")"
       class="fixed right-7 bottom-7 w-16 h-16 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-5xl leading-[64px] text-center shadow-xl">+</a>
</div>

<script>
    function toggleMenu(id) {
        document.querySelectorAll('[id^="menu-"]').forEach(el => {
            if (el.id !== `menu-${id}`) el.classList.add('hidden');
        });
        const menu = document.getElementById(`menu-${id}`);
        if (menu) menu.classList.toggle('hidden');
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('[onclick^="toggleMenu"]') && !e.target.closest('[id^="menu-"]')) {
            document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden'));
        }
    });
</script>
