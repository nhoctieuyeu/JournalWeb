@model List<JournalWeb.Models.NhatKy>

<style>
    .list {
        max-width: 640px;
        margin: auto;
        padding: 15px;
    }

    .card {
        border-radius: 14px;
        margin-bottom: 15px;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 10px;
    }

    .media-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: #eef2f7;
        min-height: 90px;
    }

        .media-item.big {
            grid-row: span 2;
            min-height: 190px;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .media-tag {
        position: absolute;
        right: 8px;
        bottom: 8px;
        font-size: 11px;
        color: #fff;
        background: rgba(0, 0, 0, .55);
        padding: 2px 7px;
        border-radius: 16px;
    }

    .emotion-card {
        position: relative;
    }

    .emotion-art {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .emotion-svg-wrap {
        width: 120px;
        height: 120px;
        filter: drop-shadow(0 10px 16px rgba(0,0,0,.12));
    }

    .emotion-name {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 8px;
        text-align: center;
        font-weight: 700;
        font-size: 12px;
        color: #2a2d47;
        background: rgba(255,255,255,.72);
        padding: 2px 8px;
        border-radius: 10px;
    }

    .emotion-svg-wrap .layer1 {
        animation: cardRippleA 4s ease-in-out infinite;
        transform-origin: 50% 50%;
    }

    .emotion-svg-wrap .layer2 {
        animation: cardRippleB 3.2s ease-in-out infinite;
        transform-origin: 50% 50%;
    }

    .emotion-svg-wrap .layer3 {
        animation: cardRippleC 2.8s ease-in-out infinite;
        transform-origin: 50% 50%;
    }

    .emotion-svg-wrap .core {
        animation: cardCoreGlow 2.2s ease-in-out infinite;
        transform-origin: 50% 50%;
    }

    @@keyframes cardRippleA {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.03) rotate(-2deg);
        }
    }

    @@keyframes cardRippleB {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.05) rotate(2deg);
        }
    }

    @@keyframes cardRippleC {
        0%, 100% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.07) rotate(-3deg);
        }
    }

    @@keyframes cardCoreGlow {
        0%, 100% {
            opacity: .82;
        }

        50% {
            opacity: 1;
        }
    }

    .fab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        font-size: 28px;
    }
</style>

<div class="list">
    @foreach (var item in Model)
    {
        var noiDungHienThi = item.NoiDung ?? "";
        var moodLabel = "";
        var moodLevelRaw = "";
        var moodBg = "";

        var camXucRaw = item.CamXuc ?? "";
        if (!string.IsNullOrWhiteSpace(camXucRaw))
        {
            var splitCamXuc = camXucRaw.IndexOf('|');
            if (splitCamXuc > -1)
            {
                moodLevelRaw = camXucRaw.Substring(0, splitCamXuc);
                moodLabel = camXucRaw.Substring(splitCamXuc + 1);
            }
            else
            {
                moodLevelRaw = "3";
                moodLabel = camXucRaw;
            }
        }

        if (string.IsNullOrWhiteSpace(moodLabel) && noiDungHienThi.StartsWith("[[MOOD|"))
        {
            var end = noiDungHienThi.IndexOf("]]", StringComparison.Ordinal);
            if (end > 0)
            {
                var token = noiDungHienThi.Substring(7, end - 7);
                var splitIndex = token.IndexOf('|');
                if (splitIndex > -1)
                {
                    moodLevelRaw = token.Substring(0, splitIndex);
                    moodLabel = token.Substring(splitIndex + 1);
                    noiDungHienThi = noiDungHienThi.Substring(end + 2).Trim();
                }
            }
        }

        if (!string.IsNullOrWhiteSpace(moodLabel))
        {
            switch (moodLevelRaw)
            {
                case "0": moodBg = "radial-gradient(circle at 50% 25%, #d9d2ef, #bcb0e3)"; break;
                case "1": moodBg = "radial-gradient(circle at 50% 25%, #d7e2fb, #beccef)"; break;
                case "2": moodBg = "radial-gradient(circle at 50% 25%, #dff0f8, #cbdeee)"; break;
                case "3": moodBg = "radial-gradient(circle at 50% 25%, #e0eef2, #c9dde2)"; break;
                case "4": moodBg = "radial-gradient(circle at 50% 25%, #e4f5d8, #cce6ba)"; break;
                case "5": moodBg = "radial-gradient(circle at 50% 25%, #f9efc8, #eedca5)"; break;
                default: moodBg = "radial-gradient(circle at 50% 25%, #f8e4ba, #f0cf96)"; break;
            }
        }

        <div class="card p-3 shadow-sm">
            <small class="text-muted">@(item.NgayViet?.ToString("dd/MM/yyyy") ?? "")</small>

            @if (!string.IsNullOrWhiteSpace(item.TieuDe))
            {
                <h6 class="mt-1">@item.TieuDe</h6>
            }

            <p class="mb-1">@noiDungHienThi</p>

            @{
                var medias = item.Medias?.ToList() ?? new List<JournalWeb.Models.NhatKyMedia>();
            }

            @if (!string.IsNullOrWhiteSpace(moodLabel) || medias.Any())
            {
                <div class="media-grid">
                    @if (!string.IsNullOrWhiteSpace(moodLabel))
                    {
                        <div class="media-item big emotion-card" style="background:@moodBg">
                            <div class="emotion-art">
                                <div class="emotion-svg-wrap js-mood-svg" data-level="@moodLevelRaw"></div>
                            </div>
                            <div class="emotion-name">@moodLabel</div>
                        </div>
                    }

                    @for (int i = 0; i < medias.Count; i++)
                    {
                        var media = medias[i];
                        var bigClass = string.IsNullOrWhiteSpace(moodLabel) && i == 0 ? "big" : "";

                        <div class="media-item @bigClass">
                            @if (media.LoaiMedia == "video")
                            {
                                <video src="@media.DuongDanFile" controls playsinline></video>
                                <span class="media-tag">Video</span>
                            }
                            else
                            {
                                <img src="@media.DuongDanFile" alt="media" />
                                <span class="media-tag">Ảnh</span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

<a href="@Url.Action("Create")" class="btn btn-primary fab">+</a>

<script>
    const moodPalette = {
        "0": { c1: "#f4ebff", c2: "#c39aff", c3: "#7c4bc4", petals: 14, sharp: 2.6, amp: .26 },
        "1": { c1: "#eef4ff", c2: "#9fb8ff", c3: "#5278e5", petals: 11, sharp: 2.1, amp: .22 },
        "2": { c1: "#ecf8ff", c2: "#92cdf5", c3: "#4a9fdb", petals: 8, sharp: 1.45, amp: .16 },
        "3": { c1: "#f6fdff", c2: "#a8dcee", c3: "#77b8cf", rings: true },
        "4": { c1: "#f2ffe7", c2: "#a5e86f", c3: "#6bc436", petals: 5, sharp: 1.05, amp: .11 },
        "5": { c1: "#fff8df", c2: "#ffde58", c3: "#f0b21f", petals: 7, sharp: 1.28, amp: .17 },
        "6": { c1: "#fff7e3", c2: "#ffc75f", c3: "#f09d17", petals: 9, sharp: 0.9, amp: .22 }
    };

    function flowerPoints(radius, petals, amp, sharp, phase = 0, count = 220) {
        let pts = [];
        for (let i = 0; i < count; i++) {
            const t = (Math.PI * 2 * i) / count;
            const wave = Math.sin(petals * t + phase);
            const softened = Math.sign(wave) * Math.pow(Math.abs(wave), sharp);
            const r = radius * (1 + amp * softened);
            const x = 50 + r * Math.cos(t);
            const y = 50 + r * Math.sin(t);
            pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
        }
        return pts.join(' ');
    }

    function moodSvg(mood, idPrefix) {
        const grad1 = `${idPrefix}-g1`;
        const gradA = `${idPrefix}-ga`;
        const gradB = `${idPrefix}-gb`;
        const gradC = `${idPrefix}-gc`;

        if (mood.rings) {
            return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle class="layer1" cx="50" cy="50" r="42" fill="none" stroke="${mood.c1}" stroke-width="1.2"/>
                <circle class="layer2" cx="50" cy="50" r="31" fill="none" stroke="${mood.c2}" stroke-width="1.6"/>
                <circle class="layer3" cx="50" cy="50" r="20" fill="url(#${grad1})" stroke="${mood.c3}" stroke-width="1.2"/>
                <circle class="core" cx="50" cy="50" r="4.5" fill="#fff"/>
                <defs><radialGradient id="${grad1}" cx="35%" cy="30%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="${mood.c2}"/></radialGradient></defs>
            </svg>`;
        }

        const p1 = flowerPoints(38, mood.petals || 8, mood.amp || .18, mood.sharp || 1.4, 0);
        const p2 = flowerPoints(29, Math.max(4, (mood.petals || 8) - 1), Math.max(.05, (mood.amp || .18) - .04), Math.max(.8, (mood.sharp || 1.4) - .15), .3);
        const p3 = flowerPoints(20, Math.max(4, (mood.petals || 8) - 2), Math.max(.04, (mood.amp || .18) - .08), Math.max(.7, (mood.sharp || 1.4) - .22), -.3);

        return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="${gradA}" cx="30%" cy="28%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="${mood.c1}"/></radialGradient>
                <radialGradient id="${gradB}" cx="35%" cy="32%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="${mood.c2}"/></radialGradient>
                <radialGradient id="${gradC}" cx="40%" cy="34%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="${mood.c3}"/></radialGradient>
            </defs>
            <polygon class="layer1" points="${p1}" fill="url(#${gradA})" stroke="${mood.c3}" stroke-opacity=".42" stroke-width=".8"/>
            <polygon class="layer2" points="${p2}" fill="url(#${gradB})" stroke="${mood.c3}" stroke-opacity=".56" stroke-width=".9"/>
            <polygon class="layer3" points="${p3}" fill="url(#${gradC})" stroke="${mood.c3}" stroke-opacity=".76" stroke-width="1"/>
            <circle class="core" cx="50" cy="50" r="2.8" fill="#fff"/>
        </svg>`;
    }

    document.querySelectorAll('.js-mood-svg').forEach((el, idx) => {
        const level = el.getAttribute('data-level') || '0';
        const mood = moodPalette[level] || moodPalette['0'];
        el.innerHTML = moodSvg(mood, `idx-${idx}`);
    });
</script>
